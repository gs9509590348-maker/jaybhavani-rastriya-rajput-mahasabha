<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Unified Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#7b1fa2;color:#fff;padding:12px;text-align:center;font-size:18px;font-weight:700}
.container{padding:10px}
.controls{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.controls input,.controls select{padding:6px;font-size:13px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
th{background:#eee}
button{padding:4px 8px;border:none;border-radius:4px;font-size:11px;cursor:pointer}
.approve{background:#2e7d32;color:#fff}
.reject{background:#c62828;color:#fff}
.hook{background:#1565c0;color:#fff}
.edit{background:#f9a825;color:#000}
.status-Pending{color:#ff9800;font-weight:700}
.status-Approved{color:#2e7d32;font-weight:700}
.status-Rejected{color:#c62828;font-weight:700}

/* MODAL */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6)}
.modal-box{background:#fff;width:90%;max-width:420px;margin:60px auto;padding:10px;border-radius:6px}
.modal-box h3{text-align:center;margin:5px 0}
.modal-box input,.modal-box select{width:100%;padding:6px;margin:4px 0;font-size:13px}
.modal-box button{margin-top:6px;width:48%}
.modal-box img{width:120px;height:120px;object-fit:cover;border-radius:8px;display:none;margin:6px auto}
</style>
</head>

<body>

<script>
/* ========= LOGIN ========= */
const ROLE = prompt(
"Role ‡§≤‡§ø‡§ñ‡•á‡§Ç:\nmain-admin\nnational-president\nyouth-national-president\nstate-president\nyouth-state-president\ndistrict-president\nyouth-district-president"
);
const PASS = prompt("Passcode ‡§≤‡§ø‡§ñ‡•á‡§Ç");

const ROLE_KEYS={
 "main-admin":"JBRRMS@ROOT",
 "national-president":"JBRRMS@NP",
 "youth-national-president":"JBRRMS@YNP",
 "state-president":"JBRRMS@SP",
 "youth-state-president":"JBRRMS@YSP",
 "district-president":"JBRRMS@DP",
 "youth-district-president":"JBRRMS@YDP"
};

if(!ROLE_KEYS[ROLE] || ROLE_KEYS[ROLE]!==PASS){
 document.body.innerHTML="<h2 style='text-align:center;margin-top:40px;color:red'>üö´ Access Denied</h2>";
 throw new Error("Unauthorized");
}

const PERMISSION={
 "main-admin":{approve:1,reject:1},
 "national-president":{approve:1,reject:1},
 "youth-national-president":{approve:0,reject:1},
 "state-president":{approve:0,reject:1},
 "youth-state-president":{approve:0,reject:0},
 "district-president":{approve:0,reject:1},
 "youth-district-president":{approve:0,reject:0}
};
const P=PERMISSION[ROLE];

let STATE="", DISTRICT="", TEHSIL="";
</script>

<header>üö© JBRRMS Unified Admin Panel</header>

<div class="container">

<div class="controls">
<input id="search" placeholder="‡§®‡§æ‡§Æ / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ / Member ID">
<select id="stateSelect"></select>
<select id="districtSelect"></select>
<select id="tehsilSelect"></select>
<select id="statusFilter">
<option value="All">All</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>
<option value="Rejected">Rejected</option>
</select>
<button class="hook" onclick="meeting()">üì¢ ‡§¨‡•à‡§†‡§ï</button>
</div>

<table>
<thead>
<tr>
<th>ID</th><th>‡§®‡§æ‡§Æ</th><th>‡§™‡§¶</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
<th>‡§ú‡§ø‡§≤‡§æ</th><th>‡§§‡§π‡§∏‡•Ä‡§≤</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
 <div class="modal-box">
  <h3>Edit Member</h3>
  <input id="e_member_code" placeholder="Member Code">
  <input id="e_name" placeholder="Name">
  <input id="e_father" placeholder="Father Name">
  <input id="e_post" placeholder="Post">
  <input id="e_district" placeholder="District">
  <input id="e_state" placeholder="State">
  <input id="e_mobile" placeholder="Mobile">
  <select id="e_status">
   <option value="Pending">Pending</option>
   <option value="Approved">Approved</option>
   <option value="Rejected">Rejected</option>
  </select>
  <img id="photoPreview">
  <input type="file" id="photoFile" accept="image/*">
  <div style="display:flex;justify-content:space-between">
   <button class="approve" onclick="saveEdit()">Save</button>
   <button class="reject" onclick="closeEdit()">Cancel</button>
  </div>
 </div>
</div>

<script>
/* ========= SUPABASE ========= */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc"
);

/* ========= DATA ========= */
const DATA={
 "Rajasthan":{
  "Jhalawar":["Jhalarapatan","Aklera","Pirawa","ManoharThana"],
  "Kota":["Kota","Sangod","Digod","Pipalda"],
  "Baran":["Baran","Chhabra","Anta"],
  "Bundi":["Bundi","Nainwa","Keshoraipatan"]
 },
 "Madhya Pradesh":{
  "Rajgarh":["Rajgarh","Biaora","Narsinghgarh","Sarangpur"],
  "Mandsaur":["Mandsaur","Malhargarh","Sitamau","Garoth","Bhanpura","Suwasra","Shamgarh"],
  "Neemuch":["Neemuch","Manasa","Jawad"],
  "Ratlam":["Ratlam","Jaora","Alot","Sailana"],
  "Ujjain":["Ujjain","Mahidpur","Khachrod","Tarana"],
  "Indore":["Indore","Depalpur","Sanwer","Mhow"],
  "Shajapur":["Shajapur","Agar","Susner"],
  "Agar Malwa":["Agar","Barod"],
  "Guna":["Guna","Aron","Chachoda"]
 }
};

/* ========= ELEMENTS ========= */
const stateSel=stateSelect, districtSel=districtSelect, tehsilSel=tehsilSelect;
const tbody=document.getElementById("tbody");
const search=document.getElementById("search");
const statusFilter=document.getElementById("statusFilter");
const photoFile=document.getElementById("photoFile");
const photoPreview=document.getElementById("photoPreview");

let editId=null;
let selectedPhotoFile=null;

/* INIT DROPDOWNS */
stateSel.innerHTML='<option value="">All State</option>';
Object.keys(DATA).forEach(s=>stateSel.innerHTML+=`<option>${s}</option>`);
districtSel.innerHTML='<option value="">All District</option>';
tehsilSel.innerHTML='<option value="">All Tehsil</option>';

/* DROPDOWN EVENTS */
stateSel.onchange=()=>{
 STATE=stateSel.value; DISTRICT=""; TEHSIL="";
 districtSel.innerHTML='<option value="">All District</option>';
 tehsilSel.innerHTML='<option value="">All Tehsil</option>';
 if(DATA[STATE]) Object.keys(DATA[STATE]).forEach(d=>districtSel.innerHTML+=`<option>${d}</option>`);
 loadMembers();
};
districtSel.onchange=()=>{
 DISTRICT=districtSel.value; TEHSIL="";
 tehsilSel.innerHTML='<option value="">All Tehsil</option>';
 if(DATA[STATE]?.[DISTRICT]) DATA[STATE][DISTRICT].forEach(t=>tehsilSel.innerHTML+=`<option>${t}</option>`);
 loadMembers();
};
tehsilSel.onchange=()=>{TEHSIL=tehsilSel.value; loadMembers();};

/* ROLE LOCK */
if(ROLE.includes("state")){
 STATE=prompt("State ‡§≤‡§ø‡§ñ‡•á‡§Ç"); stateSel.value=STATE; stateSel.disabled=true; stateSel.onchange();
}
if(ROLE.includes("district")){
 STATE=prompt("State ‡§≤‡§ø‡§ñ‡•á‡§Ç"); DISTRICT=prompt("District ‡§≤‡§ø‡§ñ‡•á‡§Ç");
 stateSel.value=STATE; districtSel.value=DISTRICT; stateSel.disabled=true; districtSel.disabled=true;
 stateSel.onchange(); districtSel.onchange();
}

/* LOAD MEMBERS */
async function loadMembers(){
 let q=sb.from("JBRRMS").select("*").order("id",{ascending:false});
 if(statusFilter.value!=="All") q=q.eq("status",statusFilter.value);
 if(STATE) q=q.eq("state",STATE);
 if(DISTRICT) q=q.eq("district",DISTRICT);
 if(TEHSIL) q=q.eq("tehsil",TEHSIL);

 const {data=[]}=await q;
 tbody.innerHTML="";
 const term=(search.value||"").toLowerCase();

 data.filter(m=>
  !term ||
  (m.name||"").toLowerCase().includes(term) ||
  (m.mobile||"").includes(term)
 ).forEach(m=>{
  tbody.innerHTML+=`
<tr>
<td>${m.id}</td>
<td>${m.name||""}</td>
<td>${m.post||""}</td>
<td>${m.mobile||""}</td>
<td>${m.district||""}</td>
<td>${m.tehsil||""}</td>
<td class="status-${m.status}">${m.status}</td>
<td>
${P.approve && m.status==="Pending"?`<button class="approve" onclick="approve(${m.id})">Approve</button>`:""}
${P.reject?`<button class="reject" onclick="reject(${m.id})">Reject</button>`:""}
<button class="hook" onclick="openEdit(${m.id})">Edit</button>
<button class="hook" onclick="appointment(${m.id})">‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§‡§ø ‡§™‡§§‡•ç‡§∞</button>
</td>
</tr>`;
 });
}

/* APPROVE / REJECT */
async function approve(id){
 const code="JBRRMS"+String(id).padStart(5,"0");
 await sb.from("JBRRMS").update({status:"Approved",member_code:code}).eq("id",id);
 loadMembers();
}
async function reject(id){
 await sb.from("JBRRMS").update({status:"Rejected"}).eq("id",id);
 loadMembers();
}

/* EDIT MODAL */
async function openEdit(id){
 editId=id;
 const {data}=await sb.from("JBRRMS").select("*").eq("id",id).single();

 e_member_code.value=data.member_code||"";
 e_name.value=data.name||"";
 e_father.value=data.father_name||"";
 e_post.value=data.post||"";
 e_district.value=data.district||"";
 e_state.value=data.state||"";
 e_mobile.value=data.mobile||"";
 e_status.value=data.status||"Pending";

 selectedPhotoFile=null;
 if(data.photo_url){photoPreview.src=data.photo_url; photoPreview.style.display="block";}
 else photoPreview.style.display="none";

 photoFile.disabled = data.status!=="Approved";
 document.getElementById("editModal").style.display="block";
}
function closeEdit(){editId=null;document.getElementById("editModal").style.display="none";}

/* PHOTO PREVIEW */
photoFile.onchange=e=>{
 const file=e.target.files[0];
 if(!file) return;
 selectedPhotoFile=file;
 const r=new FileReader();
 r.onload=ev=>{photoPreview.src=ev.target.result; photoPreview.style.display="block";}
 r.readAsDataURL(file);
};

/* SAVE EDIT */
async function saveEdit(){
 if(selectedPhotoFile && e_status.value!=="Approved"){alert("Photo update only for Approved members"); return;}
 if(selectedPhotoFile && !confirm("‚ö†Ô∏è Photo replace ‡§π‡•ã‡§ó‡•Ä, sure?")) return;

 let photoUrl=null;
 if(selectedPhotoFile){
  const name=(e_member_code.value||("JBRRMS"+editId))+".jpg";
  await sb.storage.from("members").upload("photos/"+name, selectedPhotoFile, {upsert:true});
  photoUrl="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/photos/"+name+"?v="+Date.now();
 }

 await sb.from("JBRRMS").update({
  member_code:e_member_code.value,
  name:e_name.value,
  father_name:e_father.value,
  post:e_post.value,
  district:e_district.value,
  state:e_state.value,
  mobile:e_mobile.value,
  status:e_status.value,
  ...(photoUrl && {photo_url:photoUrl})
 }).eq("id",editId);

 closeEdit();
 loadMembers();
}

/* APPOINTMENT HOOK */
async function appointment(id){
 const {data:m}=await sb.from("JBRRMS").select("*").eq("id",id).single();
 if(m.status!=="Approved"){alert("‡§ï‡•á‡§µ‡§≤ Approved ‡§∏‡§¶‡§∏‡•ç‡§Ø"); return;}
 alert("‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§‡§ø ‡§™‡§§‡•ç‡§∞ / Certificate / ID Card generator hook ready");
}

/* MEETING */
function meeting(){
 const t=prompt("‡§¨‡•à‡§†‡§ï ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç");
 if(t) window.open("https://wa.me/?text="+encodeURIComponent("üö© JBRRMS üö©\n\n"+t));
}

search.oninput=loadMembers;
statusFilter.onchange=loadMembers;
loadMembers();
</script>

</body>
</html>
