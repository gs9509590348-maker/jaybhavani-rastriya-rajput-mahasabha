<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS ‚Äì Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#fff}
header{background:#000;padding:14px;text-align:center;font-size:20px;font-weight:900;color:#d4af37}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #333;padding:6px;text-align:center}
th{background:#222;color:#f5c542}
tr:nth-child(even){background:#1a1a1a}

button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-weight:700}
.approve{background:#0a8f3c;color:#fff}
.reject{background:#b00020;color:#fff}
.view{background:#c69214;color:#000}
.del{background:#444;color:#fff}

.topbar{display:flex;justify-content:space-between;padding:10px}
.logout{background:#900;color:#fff}

/* MODAL */
#editBox{
display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.85);z-index:999;
}
#editInner{
background:#111;max-width:420px;margin:40px auto;padding:16px;
border-radius:10px;border:2px solid #d4af37
}
#editInner h3{text-align:center;color:#f5c542}
#editInner input{width:100%;padding:8px;margin:5px 0}
</style>
</head>

<body>

<header>JBRRMS ‚Äì ADMIN PANEL (FULL CONTROL)</header>

<div class="topbar">
<div>‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä</div>
<button class="logout" onclick="logout()">Logout</button>
</div>

<table>
<thead>
<tr>
<th>#</th>
<th>Member Code</th>
<th>‡§®‡§æ‡§Æ</th>
<th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
<th>‡§ú‡§ø‡§≤‡§æ</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<!-- EDIT MODAL -->
<div id="editBox">
 <div id="editInner">
  <h3>Edit Member Details</h3>

  <input id="e_id" hidden>
  <input id="e_name" placeholder="‡§®‡§æ‡§Æ">
  <input id="e_post" placeholder="‡§™‡§¶">
  <input id="e_father" placeholder="‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ">
  <input id="e_mobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤">
  <input id="e_district" placeholder="‡§ú‡§ø‡§≤‡§æ">
  <input id="e_state" placeholder="‡§∞‡§æ‡§ú‡•ç‡§Ø">

  <button class="approve" onclick="saveEdit()">üíæ Save</button>
  <button class="del" onclick="closeEdit()">Cancel</button>
 </div>
</div>

<script>
/* üîê ADMIN SESSION CHECK */
if(sessionStorage.getItem("admin")!=="yes"){
 location.href="admin-login.html";
}

/* üîó SUPABASE (SERVICE ROLE KEY ONLY) */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc"
);

const list = document.getElementById("list");

/* üì• LOAD MEMBERS */
async function loadMembers(){
 list.innerHTML="";
 const {data,error} = await sb
  .from("JBRRMS")
  .select("*")
  .order("created_at",{ascending:false});

 if(error){ alert("Data load error"); return; }

 data.forEach((m,i)=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${i+1}</td>
   <td>${m.member_code||"-"}</td>
   <td>${m.name}</td>
   <td>${m.mobile}</td>
   <td>${m.district||""}</td>
   <td>${m.status}</td>
   <td>
    ${m.status!=="Approved"
     ? `<button class="approve" onclick="approve('${m.id}')">Approve</button>`
     : `<button class="view" onclick="openID('${m.member_code}')">ID Card</button>`
    }
    <button class="view" onclick='openEdit(${JSON.stringify(m)})'>‚úèÔ∏è Edit</button>
    <button class="reject" onclick="reject('${m.id}')">Reject</button>
    <button class="del" onclick="delMember('${m.id}')">Delete</button>
   </td>
  `;
  list.appendChild(tr);
 });
}

/* ‚úÖ APPROVE */
async function approve(id){
 if(!confirm("Approve this member?")) return;

 const code = "JBRRMS" + Date.now().toString().slice(-6);

 await sb.from("JBRRMS").update({
  status:"Approved",
  member_code:code
 }).eq("id",id);

 loadMembers();
 setTimeout(()=>openID(code),300);
}

/* ‚ùå REJECT */
async function reject(id){
 if(!confirm("Reject this member?")) return;
 await sb.from("JBRRMS").update({status:"Rejected"}).eq("id",id);
 loadMembers();
}

/* üóë DELETE */
async function delMember(id){
 if(!confirm("Delete permanently?")) return;
 await sb.from("JBRRMS").delete().eq("id",id);
 loadMembers();
}

/* üÜî OPEN ID CARD */
function openID(code){
 window.open("member-card.html?code="+code,"_blank");
}

/* ‚úèÔ∏è EDIT */
function openEdit(m){
 editBox.style.display="block";
 e_id.value=m.id;
 e_name.value=m.name||"";
 e_post.value=m.post||"";
 e_father.value=m.father_name||"";
 e_mobile.value=m.mobile||"";
 e_district.value=m.district||"";
 e_state.value=m.state||"";
}

function closeEdit(){
 editBox.style.display="none";
}

async function saveEdit(){
 await sb.from("JBRRMS").update({
  name:e_name.value,
  post:e_post.value,
  father_name:e_father.value,
  mobile:e_mobile.value,
  district:e_district.value,
  state:e_state.value
 }).eq("id",e_id.value);

 closeEdit();
 loadMembers();
 alert("Member updated successfully ‚úÖ");
}

/* üö™ LOGOUT */
function logout(){
 sessionStorage.removeItem("admin");
 location.href="admin-login.html";
}

loadMembers();
</script>

</body>
</html>
