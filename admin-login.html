<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#7b1fa2;color:#fff;padding:12px;text-align:center;font-size:18px;font-weight:700}
.container{padding:10px}

.controls{display:flex;gap:6px;margin-bottom:8px}
.controls input,.controls select{flex:1;padding:6px;font-size:13px}

table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
th{background:#eee}

button{padding:4px 7px;font-size:11px;border:none;border-radius:4px;cursor:pointer}
.approve{background:#2e7d32;color:#fff}
.reject{background:#c62828;color:#fff}
.edit{background:#f9a825;color:#000}
.hook{background:#1565c0;color:#fff}

.status-Pending{color:#ff9800;font-weight:700}
.status-Approved{color:#2e7d32;font-weight:700}
.status-Rejected{color:#c62828;font-weight:700}

/* MODAL */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6)}
.modal-box{background:#fff;width:90%;max-width:420px;margin:60px auto;padding:10px;border-radius:6px}
.modal-box h3{text-align:center;margin:5px 0}
.modal-box input,.modal-box select{width:100%;padding:6px;margin:4px 0;font-size:13px}
.modal-box button{margin-top:6px;width:48%}
</style>
</head>

<body>

<!-- üîê SIMPLE ADMIN PASSWORD -->
<script>
const ADMIN_PASSWORD = "JBRRMS@2026";

const entered = prompt("Enter Admin Password");
if (entered !== ADMIN_PASSWORD) {
  alert("‚ùå Wrong Password");
  document.body.innerHTML =
    "<h2 style='text-align:center;margin-top:40px;color:red'>Access Denied</h2>";
}
</script>

<header>JBRRMS ‚Äì All-in-One Admin Panel</header>

<div class="container">

<div class="controls">
 <input id="search" placeholder="‡§®‡§æ‡§Æ / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ / Member ID">
 <select id="statusFilter">
  <option value="All">All</option>
  <option value="Pending">Pending</option>
  <option value="Approved">Approved</option>
  <option value="Rejected">Rejected</option>
 </select>
</div>

<table>
<thead>
<tr>
 <th>ID</th>
 <th>Name</th>
 <th>Post</th>
 <th>Mobile</th>
 <th>District</th>
 <th>Status</th>
 <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
 <div class="modal-box">
  <h3>Edit Member</h3>

  <input id="e_member_code" placeholder="Member Code">
  <input id="e_name" placeholder="Name">
  <input id="e_father" placeholder="Father Name">
  <input id="e_post" placeholder="Post">
  <input id="e_district" placeholder="District">
  <input id="e_state" placeholder="State">
  <input id="e_mobile" placeholder="Mobile">

  <select id="e_status">
   <option value="Pending">Pending</option>
   <option value="Approved">Approved</option>
   <option value="Rejected">Rejected</option>
  </select>

  <div style="display:flex;justify-content:space-between">
   <button class="approve" onclick="saveEdit()">Save</button>
   <button class="reject" onclick="closeEdit()">Cancel</button>
  </div>
 </div>
</div>

<script>
"use strict";

/* SUPABASE CONFIG */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc"
);

const tbody = document.getElementById("tbody");
const searchInput = document.getElementById("search");
const statusFilter = document.getElementById("statusFilter");

let editId = null;

/* LOAD MEMBERS */
async function loadMembers(){
 let q = sb.from("JBRRMS").select("*").order("id",{ascending:false});
 if(statusFilter.value!=="All") q = q.eq("status",statusFilter.value);

 const {data,error} = await q;
 if(error){ alert(error.message); return; }

 const term = (searchInput.value||"").toLowerCase();
 tbody.innerHTML="";

 data.filter(m=>{
  return !term ||
   (m.name||"").toLowerCase().includes(term) ||
   (m.mobile||"").includes(term) ||
   (m.member_code||"").toLowerCase().includes(term);
 }).forEach(m=>{
  tbody.insertAdjacentHTML("beforeend",`
  <tr>
   <td>${m.id}</td>
   <td>${m.name||""}</td>
   <td>${m.post||"-"}</td>
   <td>${m.mobile||""}</td>
   <td>${m.district||"-"}</td>
   <td class="status-${m.status}">${m.status}</td>
   <td>
    ${m.status==="Pending"?`
     <button class="approve" onclick="approveAll(${m.id})">
 Approve + WA + ID
</button>
     <button class="reject" onclick="reject(${m.id})">Reject</button>
    `:`
     <button class="edit" onclick="openEdit(${m.id})">Edit</button>
     <button class="hook" onclick="openAll('${m.member_code}')">All</button>
    `}
   </td>
  </tr>
  `);
 });
}

// ü§ñ ONE CLICK APPROVE + WA + ID CARD
function approveOneClick(member){
 const msg = `
üö© ‡§ú‡§Ø ‡§≠‡§µ‡§æ‡§®‡•Ä ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø ‡§∞‡§æ‡§ú‡§™‡•Ç‡§§ ‡§Æ‡§π‡§æ‡§∏‡§≠‡§æ üö©

‡§™‡•ç‡§∞‡§ø‡§Ø ${member.name},

‡§Ü‡§™‡§ï‡§æ ‡§Ü‡§µ‡•á‡§¶‡§® *Approved* ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§

üìå Member ID: ${member.member_code}
üìå ‡§™‡§¶: ${member.post || "-"}
üìå ‡§ú‡§ø‡§≤‡§æ: ${member.district || "-"}

üëâ ‡§Ö‡§™‡§®‡§æ ID Card ‡§¶‡•á‡§ñ‡•á‡§Ç:
${location.origin}/id-card.html?code=${member.member_code}

‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‚Äî
‡§™‡§¶ ‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§∏‡•ç‡§µ‡§æ‡§≠‡§ø‡§Æ‡§æ‡§® ‡§π‡•à‡•§

üö© ‡§ú‡§Ø ‡§≠‡§µ‡§æ‡§®‡•Ä üö©
`;

 // WhatsApp
 window.open(
  "https://wa.me/91"+member.mobile+
  "?text="+encodeURIComponent(msg),
  "_blank"
 );

 // ID Card
 window.open(
  "id-card.html?code="+member.member_code,
  "_blank"
 );
}

async function approveAll(id){
 if(!confirm("Approve + WhatsApp + ID Card?")) return;

 const code = "JBRRMS"+String(id).padStart(4,"0");

 // Update DB
 await sb.from("JBRRMS").update({
  status:"Approved",
  member_code:code
 }).eq("id",id);

 // Fetch member
 const {data:member} = await sb
  .from("JBRRMS")
  .select("*")
  .eq("id",id)
  .single();

 // One click action
 approveOneClick(member);

 loadMembers();
}

async function reject(id){
 await sb.from("JBRRMS").update({status:"Rejected"}).eq("id",id);
 loadMembers();
}

/* EDIT */
async function openEdit(id){
 editId=id;
 const {data} = await sb.from("JBRRMS").select("*").eq("id",id).single();
 e_member_code.value=data.member_code||"";
 e_name.value=data.name||"";
 e_father.value=data.father_name||"";
 e_post.value=data.post||"";
 e_district.value=data.district||"";
 e_state.value=data.state||"";
 e_mobile.value=data.mobile||"";
 e_status.value=data.status||"Pending";
 document.getElementById("editModal").style.display="block";
}

function closeEdit(){
 editId=null;
 document.getElementById("editModal").style.display="none";
}

async function saveEdit(){
 await sb.from("JBRRMS").update({
  member_code:e_member_code.value,
  name:e_name.value,
  father_name:e_father.value,
  post:e_post.value,
  district:e_district.value,
  state:e_state.value,
  mobile:e_mobile.value,
  status:e_status.value
 }).eq("id",editId);

 closeEdit();
 loadMembers();
}

/* ALL LINKS */
function openAll(code){
 if(!code){alert("Member not approved");return;}
 window.open("id-card.html?code="+code,"_blank");
 window.open("certificate.html?code="+code,"_blank");
 window.open("appointment.html?code="+code,"_blank");
}

searchInput.oninput = loadMembers;
statusFilter.onchange = loadMembers;
loadMembers();
</script>

</body>
</html>
