<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0;padding:15px}
h2{text-align:center}
#loginBox,#panel{max-width:1100px;margin:auto;background:#fff;padding:25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
input,select,button{padding:10px;font-size:15px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
button{cursor:pointer;border:none;margin-top:6px}
.logout{background:#333;color:#fff;width:auto;float:right}
.approve{background:#28a745;color:#fff}
.reject{background:#dc3545;color:#fff}
.asset{background:#0b57d0;color:#fff}
.card{background:#fafafa;padding:15px;margin-bottom:15px;border-radius:10px;border:1px solid #ddd}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
.controls>*{flex:1;min-width:180px}
.info{font-size:14px;color:#555}
.loading{text-align:center;color:#666;padding:30px}
@media(max-width:600px){.controls{flex-direction:column}}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>üõ°Ô∏è JBRRMS Admin Login</h2>
  <input type="password" id="adminPass" placeholder="Admin Password">
  <br><br>
  <button onclick="login()">Login</button>
</div>

<!-- PANEL -->
<div id="panel" style="display:none">
  <button class="logout" onclick="logout()">Logout</button>
  <h2>‡§ú‡§Ø ‡§≠‡§µ‡§æ‡§®‡•Ä ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø ‡§∞‡§æ‡§ú‡§™‡•Ç‡§§ ‡§Æ‡§π‡§æ‡§∏‡§≠‡§æ ‚Äì Admin Panel</h2>

  <div class="controls">
    <input id="search" placeholder="‡§®‡§æ‡§Æ / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç" onkeyup="loadMembers()">
    <select id="statusFilter" onchange="loadMembers()">
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
      <option value="Rejected">Rejected</option>
    </select>
  </div>

  <div id="list" class="loading">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
</div>

<script>
/* ================= CONFIG ================= */
const ADMIN_PASSWORD = "jbrms@123";

const SUPABASE_URL = "https://ejdzdptqxelilkseannw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= FINAL TEMPLATE URLS (LOCKED) ================= */
const TEMPLATE_ID_FRONT = "https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png";
const TEMPLATE_ID_BACK  = "https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png";
const TEMPLATE_CERT     = "https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/certificate.png";
const TEMPLATE_APP      = "https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/appointment.png";

/* ================= AUTH ================= */
function login(){
  const pass = document.getElementById("adminPass").value;
  if(pass === ADMIN_PASSWORD){
    localStorage.setItem("JBRRMS_ADMIN","1");
    showPanel();
  } else {
    alert("‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°");
  }
}
function logout(){
  localStorage.removeItem("JBRRMS_ADMIN");
  location.reload();
}
function showPanel(){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("panel").style.display="block";
  loadMembers();
}
if(localStorage.getItem("JBRRMS_ADMIN")) showPanel();

/* ================= HELPERS ================= */
const memberCode = id => "JBRRMS" + String(id).padStart(4,"0");

/* ================= LOAD MEMBERS ================= */
async function loadMembers(){
  const list = document.getElementById("list");
  list.innerHTML="<div class='loading'>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>";

  const status = document.getElementById("statusFilter").value;
  const search = document.getElementById("search").value.trim();

  let q = sb.from("members").select("*").eq("status",status);
  if(search){
    q = q.or(`name.ilike.%${search}%,mobile.ilike.%${search}%`);
  }

  const {data,error} = await q.order("id",{ascending:true});
  if(error){list.innerHTML=error.message;return;}
  if(!data.length){list.innerHTML="<p style='text-align:center'>‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç</p>";return;}

  list.innerHTML="";
  data.forEach(m=>{
    list.innerHTML += `
    <div class="card">
      <b>${m.name}</b> (${m.mobile})<br><br>
      <div class="info">
        Member Code: <b>${m.member_code || "-"}</b><br>
        Status: <b>${m.status}</b>
      </div><br>

      ${
        status==="Pending" ?
        `
        <button class="approve" onclick="approveMember(${m.id})">
          Approve (üÜî ID Card + üìú Certificate)
        </button>
        <button class="reject" onclick="rejectMember(${m.id})">Reject</button>
        `
        :
        `
        <button class="asset" onclick="openID('${m.member_code}')">üÜî ID Card</button>
        <button class="asset" onclick="openCert('${m.member_code}')">üìú Certificate</button>
        <button class="asset" onclick="openApp('${m.member_code}')">üìÑ Appointment</button>
        `
      }
    </div>`;
  });
}

/* ================= ACTIONS ================= */
async function approveMember(id){
  if(!confirm("Approve ‡§ï‡§∞‡§§‡•á ‡§π‡•Ä üÜî ID Card ‡§î‡§∞ üìú Certificate generate ‡§π‡•ã‡§Ç‡§ó‡•á‡•§ Continue?")) return;

  const code = memberCode(id);

  const {error} = await sb.from("members").update({
    status:"Approved",
    member_code:code
  }).eq("id",id);

  if(error){alert(error.message);return;}

  // AUTO OPEN ID + CERTIFICATE
  openID(code);
  openCert(code);

  loadMembers();
}

async function rejectMember(id){
  if(!confirm("Reject ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) return;
  const {error} = await sb.from("members")
    .update({status:"Rejected"})
    .eq("id",id);
  if(error) alert(error.message);
  loadMembers();
}

/* ================= GENERATOR LINKS ================= */
function openID(code){
  window.open(`idcard.html?code=${code}`,"_blank");
}
function openCert(code){
  window.open(`certificate.html?code=${code}`,"_blank");
}
function openApp(code){
  window.open(`appointment.html?code=${code}`,"_blank");
}
</script>

</body>
</html>
