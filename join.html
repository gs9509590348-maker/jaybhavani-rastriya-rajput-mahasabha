<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>JB RRMS - Member Join + ID Card</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:10px}
.box{background:#fff;padding:15px;border-radius:12px;max-width:500px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,.2)}
input{width:100%;padding:10px;margin-top:8px}
button{padding:10px;background:#b30000;color:#fff;border:none;border-radius:10px;width:100%;margin-top:10px}
h2{text-align:center}

.idcard{margin-top:25px;text-align:center}
.card{width:300px;height:480px;position:relative;margin:auto;border-radius:15px;overflow:hidden;box-shadow:0 0 10px rgba(0,0,0,.3)}
.card img.bg{width:100%;height:100%;object-fit:cover;position:absolute}

.photo{width:110px;height:130px;border-radius:15px;overflow:hidden;position:absolute;top:120px;left:50%;transform:translateX(-50%);background:#fff}
.photo img{width:100%;height:100%;object-fit:cover}

.name,.code,.details{position:absolute;width:100%;text-align:center}
.name{top:270px;font-size:18px;font-weight:bold}
.code{top:300px;font-size:14px}
.details{top:340px;font-size:13px;line-height:18px}
</style>
</head>

<body>

<div class="box">
<h2>‡§ú‡§Ø ‡§≠‡§µ‡§æ‡§®‡•Ä ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø ‡§∞‡§æ‡§ú‡§™‡•Ç‡§§ ‡§Æ‡§π‡§æ‡§∏‡§≠‡§æ</h2>
<h3>Member Registration</h3>

<input id="name" placeholder="‡§®‡§æ‡§Æ">
<input id="father" placeholder="‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ">
<input id="mobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤">
<input id="district" placeholder="‡§ú‡§ø‡§≤‡§æ">
<input id="state" placeholder="‡§∞‡§æ‡§ú‡•ç‡§Ø">

<label>‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</label>
<input type="file" id="photo">

<button onclick="register()">Submit & Generate ID</button>

<hr>

<h3>Already Member? Get ID Card</h3>
<input id="searchCode" placeholder="Member Code ‡§°‡§æ‡§≤‡•á‡§Ç (‡§ú‡•à‡§∏‡•á JBRRMS0001)">
<button onclick="loadCard()">Load ID Card</button>

</div>

<div class="idcard" id="cardArea" style="display:none">

<h3>Member ID Card</h3>

<!-- FRONT -->
<div class="card" id="front">
<img class="bg" src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png">

<div class="photo"><img id="mphoto"></div>
<div class="name" id="mname"></div>
<div class="code" id="mcode"></div>
<div class="details" id="mdetails"></div>

</div>

<br>

<!-- BACK -->
<div class="card" id="back">
<img class="bg" src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png">

<canvas id="qr" width="90" height="90" style="position:absolute;bottom:25px;right:25px;"></canvas>

<div style="position:absolute;bottom:25px;left:15px;font-size:12px;text-align:left;color:#000;">
üìß Email: jbrrms1@gmail.com<br>
üìû Helpline: 9166377972<br>
üåê Website: www.jbrrms.in<br><br>
‚ö† ‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ ‡§∏‡§Ç‡§ó‡§†‡§® ‡§ï‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§™‡§§‡•ç‡§∞ ‡§π‡•à,<br>
‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§§‡§æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ ‡§™‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç‡•§
</div>

</div>

<button onclick="downloadPDF()">Download ID Card PDF</button>

</div>

<script>

// =================== Supabase ===================
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// =================== Cloudinary =================
const cloudName = "dlqr73p7j";
const preset = "jbrms_unsigned";

// ================= Load Face Models =============
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/dist/weights")
]).then(()=>console.log("FaceAPI Loaded"));


// ====== FACE AUTO CROP ==========================
async function cropPhoto(file){

 const img = new Image();
 img.src = URL.createObjectURL(file);
 await img.decode();

 const detection = await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions());

 const canvas=document.createElement("canvas");
 canvas.width=600;canvas.height=600;
 const ctx=canvas.getContext("2d");
 ctx.fillStyle="#eef3ff";
 ctx.fillRect(0,0,600,600);

 ctx.save();
 ctx.beginPath();
 ctx.roundRect(20,20,560,560,30);
 ctx.clip();

 let sx=0,sy=0,sw=img.width,sh=img.height;

 if(detection){
   let b=detection.box;
   sx=Math.max(0,b.x-b.width*0.5);
   sy=Math.max(0,b.y-b.height*0.5);
   sw=Math.min(img.width-sx,b.width*2);
   sh=Math.min(img.height-sy,b.height*2);
 }

 ctx.drawImage(img,sx,sy,sw,sh,0,0,600,600);
 ctx.restore();

 return await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.8));
}


// ========== UPLOAD CLOUDINARY ==================
async function upload(file,name){
 const fd=new FormData();
 fd.append("file",file);
 fd.append("upload_preset",preset);
 fd.append("public_id",name);

 let r=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,{
   method:"POST",
   body:fd
 });

 let j=await r.json();
 return j.secure_url;
}


// ========== REGISTER ===========================
async function register(){

 let n=name.value,f=father.value,m=mobile.value,d=district.value,s=state.value;

 if(!n||!f||!m||!d||!s){alert("‡§∏‡§¨ ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç");return;}

 let file=photo.files[0];
 if(!file){alert("‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç");return;}

 let member_code="JBRRMS"+Date.now();

 let blob=await cropPhoto(file);
 let url=await upload(blob,member_code);

 let {error}=await supabaseClient.from("JBRRMS").insert([
  {member_code,name:n,father_name:f,mobile:m,district:d,state:s,photo_url:url}
 ]);

 if(error){alert("Database Error");return;}

 showCard({member_code,name:n,father_name:f,mobile:m,district:d,state:s,photo_url:url});
}


// ========== LOAD CARD ==========================
async function loadCard(){
 let code=searchCode.value.trim();

 let {data,error}=await supabaseClient
   .from("JBRRMS")
   .select("*")
   .eq("member_code",code)
   .single();

 if(error){alert("Member ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");return;}

 showCard(data);
}


// ========== SHOW CARD ==========================
function showCard(d){

 mname.innerText=d.name;
 mcode.innerText="Member Code: "+d.member_code;
 mdetails.innerHTML=`Father: ${d.father_name}<br>Mobile: ${d.mobile}<br>District: ${d.district}<br>State: ${d.state}`;
 mphoto.src=d.photo_url;

 new QRious({
   element:document.getElementById("qr"),
   value:`${d.member_code} | ${d.name} | ${d.mobile} | ${d.district} | ${d.state}`,
   size:90
 });

 cardArea.style.display="block";
 window.scrollTo(0,document.body.scrollHeight);
}


// ========== PDF DOWNLOAD ========================
async function downloadPDF(){

 const front = await html2canvas(document.getElementById("front"));
 const back = await html2canvas(document.getElementById("back"));

 const { jsPDF } = window.jspdf;
 const pdf = new jsPDF("p","mm","a4");

 let fw = 80;
 let fh = fw * 1.6;

 pdf.addImage(front.toDataURL(),"PNG",20,20,fw,fh);
 pdf.addImage(back.toDataURL(),"PNG",110,20,fw,fh);

 pdf.save("JB_RRMS_ID_Card.pdf");
}

</script>
</body>
</html>
