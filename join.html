<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛ тАУ Digital System</title>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Mangal,Arial;background:#f2f2f2;margin:0;padding:10px}
h2,h3{text-align:center}
.section{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:16px}
button{background:#8b0000;color:#fff;border:none;border-radius:6px}
canvas{width:100%;max-width:1080px;border:2px solid #aaa;margin-top:10px;background:#fff}
</style>
</head>

<body>

<h2>рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</h2>

<!-- JOIN FORM -->
<div class="section">
<h3>ЁЯУЭ рд╕рджрд╕реНрдп рдЬреНрд╡рд╛рдЗрди рдлреЙрд░реНрдо</h3>
<input id="name" placeholder="рдирд╛рдо">
<input id="fname" placeholder="рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо">
<input id="mobile" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░">
<input id="district" placeholder="рдЬрд┐рд▓рд╛">
<input id="state" placeholder="рд░рд╛рдЬреНрдп">
<input type="file" id="photo" accept="image/*">
<button onclick="joinMember()">Join & Generate</button>
</div>

<!-- SEARCH -->
<div class="section">
<h3>ЁЯФН Member Code рд╕реЗ рд╕рд░реНрдЪ</h3>
<input id="searchCode" placeholder="JBRRMS00001">
<button onclick="searchMember()">Search & Generate</button>
</div>

<canvas id="certificate" width="1080" height="1678"></canvas>
<canvas id="idfront" width="540" height="856"></canvas>
<canvas id="idback" width="540" height="856"></canvas>

<div class="section">
<button onclick="downloadPNG('certificate')">ЁЯУе Certificate</button>
<button onclick="downloadPNG('idfront')">ЁЯУе ID Front</button>
<button onclick="downloadPNG('idback')">ЁЯУе ID Back</button>
<button onclick="downloadPDF()">ЁЯУД PDF</button>
</div>

<script>
let memberCode="";

/* TEMPLATE IMAGES (рдЖрдкрдХреЗ рд▓рд┐рдВрдХ) */
const certBG=new Image();
certBG.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/certificate.png";

const idFront=new Image();
idFront.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png";

const idBack=new Image();
idBack.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png";

/* ROUND RECT */
CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
 this.beginPath();
 this.moveTo(x+r,y);
 this.arcTo(x+w,y,x+w,y+h,r);
 this.arcTo(x+w,y+h,x,y+h,r);
 this.arcTo(x,y+h,x,y,r);
 this.arcTo(x,y,x+w,y,r);
 this.closePath();
};

/* JOIN */
function joinMember(){
 if(!name.value.trim()){alert("рдирд╛рдо рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реИ");return;}

 memberCode="JBRRMS"+Date.now().toString().slice(-5);

 const data={
  memberCode,
  name:name.value,
  fname:fname.value,
  mobile:mobile.value,
  district:district.value,
  state:state.value
 };
 localStorage.setItem(memberCode,JSON.stringify(data));

 generateAll();
}

/* SEARCH */
function searchMember(){
 if(!searchCode.value.trim()){alert("Member Code рдбрд╛рд▓реЗрдВ");return;}
 const data=localStorage.getItem(searchCode.value.trim());
 if(!data){alert("Member рдирд╣реАрдВ рдорд┐рд▓рд╛");return;}

 const m=JSON.parse(data);
 memberCode=m.memberCode;
 name.value=m.name;
 fname.value=m.fname;
 mobile.value=m.mobile;
 district.value=m.district;
 state.value=m.state;

 generateAll();
}

/* GENERATE */
function generateAll(){
 generateCertificate();
 generateID();
}

/* CERTIFICATE (NO PHOTO) */
function generateCertificate(){
 const c=certificate.getContext("2d");
 c.clearRect(0,0,1080,1678);
 c.drawImage(certBG,0,0,1080,1678);

 c.textAlign="center";
 c.fillStyle="#7a0000";
 c.font="bold 60px serif";
 c.fillText("рдкреНрд░рдорд╛рдг рдкрддреНрд░",540,360);

 c.font="32px serif";
 c.fillStyle="#000";
 c.textAlign="left";

 let y=520,g=60;
 line("рдирд╛рдо",name.value);
 line("рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо",fname.value);
 line("рдореЛрдмрд╛рдЗрд▓",mobile.value);
 line("рдЬрд┐рд▓рд╛",district.value);
 line("рд░рд╛рдЬреНрдп",state.value);
 line("рд╕рджрд╕реНрдп рдХреЛрдб",memberCode);

 function line(l,v){
  c.fillText(l+" :",220,y);
  c.textAlign="right";
  c.fillText(v,860,y);
  c.textAlign="left";
  y+=g;
 }

 /* LEFT SIDE INFO */
 c.save();
 c.translate(80,1150);
 c.rotate(-Math.PI/2);
 c.font="22px serif";
 c.fillText("рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди : 9166377972",0,0);
 c.fillText("рдИрдореЗрд▓ : jbrrms1@gmail.com",0,32);
 c.fillText("рд╡реЗрдмрд╕рд╛рдЗрдЯ : www.jbrrms.in",0,64);
 c.restore();

 /* QR RIGHT */
 drawQR(c,760,950,qrURL());

 /* DISCLAIMER */
 c.font="18px serif";
 c.textAlign="center";
 c.fillText(
  "рдпрд╣ рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдХреЗрд╡рд▓ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдкрд╣рдЪрд╛рди рд╣реЗрддреБ рд╣реИред рдЗрд╕рдХрд╛ рдХрд┐рд╕реА рднреА рд╕рд░рдХрд╛рд░реА рдЕрдзрд┐рдХрд╛рд░ рд╕реЗ рд╕рдВрдмрдВрдз рдирд╣реАрдВ рд╣реИред",
 540,1600
 );
}

/* ID CARD */
function generateID(){
 /* FRONT */
 const f=idfront.getContext("2d");
 f.clearRect(0,0,540,856);
 f.drawImage(idFront,0,0,540,856);
 drawPhotoCover(f,150,260,240,300);

 f.font="20px serif";
 f.fillStyle="#000";
 f.fillText(name.value,140,610);
 f.fillText(memberCode,140,645);
 f.fillText(district.value,140,680);

 /* BACK */
 const b=idback.getContext("2d");
 b.clearRect(0,0,540,856);
 b.drawImage(idBack,0,0,540,856);

 b.textAlign="center";
 b.font="bold 22px serif";
 b.fillText(name.value,270,90);

 drawQR(b,150,200,qrURL());

 b.font="16px serif";
 b.fillText("рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди : 9166377972",270,540);
 b.fillText("рдИрдореЗрд▓ : jbrrms1@gmail.com",270,570);
 b.fillText("рд╡реЗрдмрд╕рд╛рдЗрдЯ : www.jbrrms.in",270,600);

 b.font="14px serif";
 b.fillText("рдпрд╣ рдХрд╛рд░реНрдб рдХреЗрд╡рд▓ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдкрд╣рдЪрд╛рди рд╣реЗрддреБ рд╣реИред",270,640);
}

/* PHOTO AUTO FIT */
function drawPhotoCover(ctx,x,y,w,h){
 if(!photo.files[0])return;
 const img=new Image();
 img.onload=()=>{
  const ir=img.width/img.height,cr=w/h;
  let sx,sy,sw,sh;
  if(ir>cr){sh=img.height;sw=sh*cr;sx=(img.width-sw)/2;sy=0;}
  else{sw=img.width;sh=sw/cr;sx=0;sy=(img.height-sh)/2;}
  ctx.save();
  ctx.roundRect(x,y,w,h,20);
  ctx.clip();
  ctx.drawImage(img,sx,sy,sw,sh,x,y,w,h);
  ctx.restore();
 };
 img.src=URL.createObjectURL(photo.files[0]);
}

/* QR */
function qrURL(){
 return "https://www.jbrrms.in/?member="+memberCode;
}
function drawQR(ctx,x,y,text){
 QRCode.toCanvas(document.createElement("canvas"),text,{width:240},(e,qr)=>{
  ctx.drawImage(qr,x,y);
 });
}

/* DOWNLOAD ONLY */
function downloadPNG(id){
 const a=document.createElement("a");
 a.href=document.getElementById(id).toDataURL("image/png");
 a.download=memberCode+"_"+id+".png";
 a.click();
}

function downloadPDF(){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF("p","px",[1080,1678]);
 pdf.addImage(certificate.toDataURL(),"PNG",0,0,1080,1678);
 pdf.addPage([540,856],"p");
 pdf.addImage(idfront.toDataURL(),"PNG",0,0,540,856);
 pdf.addPage([540,856],"p");
 pdf.addImage(idback.toDataURL(),"PNG",0,0,540,856);
 pdf.save(memberCode+"_JB_RRMS.pdf");
}
</script>

</body>
</html>
