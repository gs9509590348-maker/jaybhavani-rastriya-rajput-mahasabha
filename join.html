<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS тАУ Royal ID Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial}
#joinBox{max-width:360px;background:#fff;margin:20px auto;padding:18px;border-radius:12px}
#joinBox h2{text-align:center;margin-top:0}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px}
button{background:#c69214;color:#fff;border:none;font-weight:800;border-radius:6px;cursor:pointer}
button:disabled{opacity:.6}

.card{display:none;position:relative;width:1080px;height:1676px;margin:20px auto}
#front{background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png") no-repeat center/cover}
#back{background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png") no-repeat center/cover}

.front-title,.back-title{
 position:absolute;width:100%;text-align:center;font-weight:900;
 background:linear-gradient(#fff2b0,#f5c542,#d4af37);
 -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.front-title{top:395px;font-size:58px}
.back-title{top:200px;font-size:60px}

.photo{
 position:absolute;top:500px;left:390px;
 width:300px;height:380px;border-radius:26px;
 overflow:hidden;border:18px solid #d4af37;background:#fff
}
.photo img{width:100%;height:100%;object-fit:cover}

.details{position:absolute;top:930px;padding-left:280px;font-size:52px;line-height:1.6}
#c_code{margin-top:14px;font-weight:900;letter-spacing:3px}

#qr{position:absolute;top:380px;left:50%;transform:translateX(-50%)}

.seven-lines{
 position:absolute;top:720px;left:50%;
 transform:translateX(-50%);
 width:760px;text-align:center;
 font-size:24px;line-height:1.55;font-weight:600
}

.back-footer{position:absolute;bottom:120px;width:100%;text-align:center;font-size:26px}
.disclaimer{position:absolute;bottom:40px;width:100%;text-align:center;font-size:20px;opacity:.85}

.actions{text-align:center;margin:20px}
.actions button{width:180px;margin:6px}

#photoStatus{font-size:13px;margin-top:4px}
</style>
</head>

<body>

<div id="joinBox">
<h2>JBRRMS Join / Search</h2>

<input id="name" placeholder="рдкреВрд░рд╛ рдирд╛рдо *">
<input id="post" placeholder="рдкрдж *">
<input id="father" placeholder="рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо">
<input id="district" placeholder="рдЬрд┐рд▓рд╛">
<input id="state" placeholder="рд░рд╛рдЬреНрдп">
<input id="mobile" placeholder="рдореЛрдмрд╛рдЗрд▓">

<input type="file" id="photoInput" accept="image/*" hidden>
<button type="button" onclick="openPicker()">ЁЯУ╕ рдлреЛрдЯреЛ рдЪреБрдиреЗрдВ</button>
<div id="photoStatus"></div>

<button onclick="joinNow()">Join Now</button>

<hr>

<input id="searchCode" placeholder="Member Code (JBRRMS000001)">
<button onclick="searchMember()">ЁЯЖФ Search ID Card</button>
</div>

<!-- FRONT -->
<div id="front" class="card">
<div class="front-title">рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</div>
<div class="photo"><img id="photo"></div>

<div class="details">
<div><b>рдирд╛рдо :</b> <span id="c_name"></span></div>
<div><b>рдкрдж :</b> <span id="c_post"></span></div>
<div><b>рдкрд┐рддрд╛ :</b> <span id="c_father"></span></div>
<div><b>рдЬрд┐рд▓рд╛ :</b> <span id="c_district"></span></div>
<div><b>рд░рд╛рдЬреНрдп :</b> <span id="c_state"></span></div>
<div><b>рдореЛрдмрд╛рдЗрд▓ :</b> <span id="c_mobile"></span></div>
<div id="c_code"></div>
</div>
</div>

<!-- BACK -->
<div id="back" class="card">
<div class="back-title">рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</div>
<div id="qr"></div>

<div class="seven-lines">
рдкрдж рд╕реЗ рдмрдбрд╝рд╛ рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣реИред<br>
рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣реИ рддреЛ рдкрд╣рдЪрд╛рди рд╣реИред<br>
рд╕реНрд╡рд╛рднрд┐рдорд╛рди рдХрднреА рдЧрд┐рд░рд╡реА рдирд╣реАрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ред<br>
рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣реА рдЕрд╕рд▓реА рд╢рдХреНрддрд┐ рд╣реИред<br>
рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣реИ, рд╡рд╣реА рд╕рдЪреНрдЪрд╛ рдмрд▓рд╡рд╛рди рд╣реИред<br>
рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╕рдордЭреМрддрд╛ рдирд╣реАрдВ рд╕рд┐рдЦрд╛рддрд╛ред<br>
рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣рдорд╛рд░реА рдЕрд╕рд▓реА рд╡рд┐рд░рд╛рд╕рдд рд╣реИред
</div>

<div class="back-footer">
рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди: 9166377972<br>
Email: jbrrms1@gmail.com<br>
Website: www.jbrrms.in
</div>

<div class="disclaimer">рдпрд╣ рдкрд╣рдЪрд╛рди рдкрддреНрд░ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдкреНрд░рдпреЛрдЬрдиреЛрдВ рд╣реЗрддреБ рд╣реИред</div>
</div>

<div class="actions">
<button onclick="showFront()">тмЕ Front</button>
<button onclick="showBack()">Back тЮб</button>
<button onclick="download()">тмЗ Download</button>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc"
);

let photoBlob=null, side="front";

function showError(msg,e=null){
 console.error(msg,e);
 alert("тЭМ Error:\n\n"+msg+"\n\nрдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");
}

function openPicker(){
 photoInput.value="";
 photoInput.click();
}

/* PHOTO HANDLE */
photoInput.addEventListener("change",e=>{
 const f=e.target.files[0];
 if(!f) return;

 const img=new Image();
 const url=URL.createObjectURL(f);
 img.src=url;

 img.onload=()=>{
  const c=document.createElement("canvas");
  c.width=c.height=600;
  const m=Math.min(img.width,img.height);
  c.getContext("2d").drawImage(
   img,(img.width-m)/2,(img.height-m)/2,m,m,0,0,600,600
  );
  URL.revokeObjectURL(url);
  c.toBlob(b=>{
   photoBlob=b;
   photo.src=c.toDataURL("image/jpeg");
   photoStatus.textContent="Photo upload рд╣реЛ рдЧрдИ рд╣реИ тЬЕ";
   photoStatus.style.color="green";
  },"image/jpeg",0.9);
 };

 img.onerror=()=>{
  URL.revokeObjectURL(url);
  showError("Photo рдкрдврд╝рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рдЖрдИ");
 };
});

/* JOIN */
async function joinNow(){
 try{
  if(!name.value || !post.value || !photoBlob){
   alert("рдирд╛рдо, рдкрдж рдФрд░ рдлреЛрдЯреЛ рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реИ");
   return;
  }

  const member_code="JBRRMS"+Date.now().toString().slice(-6);

  const fd=new FormData();
  fd.append("file",photoBlob);
  fd.append("upload_preset","jbrms_unsigned");

  const up=await fetch(
   "https://api.cloudinary.com/v1_1/dlqr73p7j/image/upload",
   {method:"POST",body:fd}
  );
  if(!up.ok) throw "Photo upload failed";

  const img=await up.json();
  if(!img.secure_url) throw "Photo URL missing";

  const {error}=await sb.from("JBRRMS").insert([{
   member_code,
   name:name.value,
   post:post.value,
   father_name:father.value,
   district:district.value,
   state:state.value,
   mobile:mobile.value,
   photo_url:img.secure_url,
   status:"Pending"
  }]);
  if(error) throw error;

  alert(
   "Photo upload рд╣реЛ рдЧрдпрд╛ рд╣реИ тЬЕ\n\n"+
   "рдЖрдкрдХрд╛ рдлреЙрд░реНрдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдмрдорд┐рдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИред\n\n"+
   "рдЕрдм рдЖрдк рдЕрдкрдирд╛ ID Card\n"+
   "Member Code рд╕реЗ\n"+
   "Search рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\n\n"+
   "рдЬрдп рднрд╡рд╛рдиреА ЁЯЪй"
  );

  searchCode.value=member_code;
  searchMember();

 }catch(e){
  showError("Join process рдкреВрд░рд╛ рдирд╣реАрдВ рд╣реЛ рдкрд╛рдпрд╛",e);
 }
}

/* SEARCH */
async function searchMember(){
 try{
  const code=searchCode.value.trim();
  if(!code) return;

  const {data,error}=await sb
   .from("JBRRMS")
   .select("*")
   .eq("member_code",code)
   .single();

  if(error || !data) throw "Member not found";

  c_name.textContent=data.name;
  c_post.textContent=data.post;
  c_father.textContent=data.father_name||"";
  c_district.textContent=data.district||"";
  c_state.textContent=data.state||"";
  c_mobile.textContent=data.mobile||"";
  c_code.textContent=data.member_code;
  photo.src=data.photo_url;

  qr.innerHTML="";
  new QRCode(qr,{text:data.member_code,width:220,height:220});

  showFront();
 }catch(e){
  showError("Member рдирд╣реАрдВ рдорд┐рд▓рд╛",e);
 }
}

function showFront(){front.style.display="block";back.style.display="none";side="front";}
function showBack(){front.style.display="none";back.style.display="block";side="back";}

/* DOWNLOAD */
function download(){
 try{
  const el=side==="front"?front:back;
  html2canvas(el,{scale:2,useCORS:true}).then(c=>{
   const a=document.createElement("a");
   a.href=c.toDataURL("image/png");
   a.download="JBRRMS_"+side+".png";
   a.click();
  });
 }catch(e){
  showError("Download рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рдЖрдИ",e);
 }
}
</script>

</body>
</html>
