<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Join + ID Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;background:#111;font-family:Arial}

/* ================= JOIN FORM ================= */
#joinBox{
 max-width:380px;
 background:#fff;
 margin:20px auto;
 padding:20px;
 border-radius:10px;
}
input,button{
 width:100%;
 padding:12px;
 margin:8px 0;
 font-size:16px;
}
button{
 background:#e65100;
 color:#fff;
 border:none;
 border-radius:6px;
 cursor:pointer;
}

/* ================= CARD COMMON ================= */
.card{
 display:none;
 width:1080px;
 height:1676px;
 margin:20px auto;
 position:relative;
 background-size:cover;
}

/* ================= FRONT ================= */
#front{
 background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png") center/cover no-repeat;
}

.org{
 position:absolute;
 top:260px;
 width:100%;
 text-align:center;
 font-size:46px;
 font-weight:bold;
 color:#ff7a00;
}

.photo{
 position:absolute;
 top:460px;
 left:390px;
 width:300px;
 height:380px;
 border-radius:26px;
 overflow:hidden;
 border:10px solid #d4af37;
}
.photo img{width:100%;height:100%;object-fit:cover}

.details{
 position:absolute;
 top:880px;
 width:100%;
 text-align:center;
 color:#000;
}
.d-name{font-size:40px;font-weight:bold}
.d-text{font-size:26px;margin-top:6px}
.d-code{font-size:30px;margin-top:12px;font-weight:bold}

/* ================= BACK ================= */
#back{
 background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png") center/cover no-repeat;
}

.back-org{
 position:absolute;
 top:180px;
 width:100%;
 text-align:center;
 font-size:44px;
 font-weight:bold;
 color:#ff7a00;
}

#qr{
 position:absolute;
 top:470px;
 left:360px;
}

.backtext{
 position:absolute;
 bottom:120px;
 width:100%;
 text-align:center;
 font-size:26px;
 line-height:1.6;
}

.actions{text-align:center;margin-bottom:30px}
</style>
</head>

<body>

<!-- ================= JOIN FORM ================= -->
<div id="joinBox">
<h3>JBRRMS Join Form</h3>

<input id="name" placeholder="पूरा नाम">
<input id="father" placeholder="पिता का नाम">
<input id="district" placeholder="जिला">
<input id="state" placeholder="राज्य">
<input id="mobile" placeholder="मोबाइल (10 अंक)">
<input type="file" id="photoInput" accept="image/*">

<button onclick="join()">Submit</button>

<hr>

<input id="oldCode" placeholder="पुराना Member Code">
<button onclick="loadOld()">Old Card Load</button>
</div>

<!-- ================= FRONT CARD ================= -->
<div id="front" class="card">
 <div class="org">जय भवानी राष्ट्रीय राजपूत महासभा</div>
 <div class="photo"><img id="photo"></div>
 <div class="details">
  <div class="d-name" id="c_name"></div>
  <div class="d-text" id="c_father"></div>
  <div class="d-text" id="c_dist"></div>
  <div class="d-text" id="c_mobile"></div>
  <div class="d-code" id="c_code"></div>
 </div>
</div>

<!-- ================= BACK CARD ================= -->
<div id="back" class="card">
 <div class="back-org">जय भवानी राष्ट्रीय राजपूत महासभा</div>
 <div id="qr"></div>
 <div class="backtext">
  हेल्पलाइन: 9166377972<br>
  Email: jbrrms1@gmail.com<br>
  Website: www.jbrrms.in<br>
  <small>यह पहचान पत्र संगठन की संपत्ति है</small>
 </div>
</div>

<div class="actions">
<button onclick="download(front,'FRONT')">⬇️ Front</button>
<button onclick="download(back,'BACK')">⬇️ Back</button>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P"
);

/* ================= ELEMENT BINDINGS ================= */
const joinBox=document.getElementById("joinBox");
const front=document.getElementById("front");
const back=document.getElementById("back");

const name=document.getElementById("name");
const father=document.getElementById("father");
const district=document.getElementById("district");
const state=document.getElementById("state");
const mobile=document.getElementById("mobile");
const photoInput=document.getElementById("photoInput");
const oldCode=document.getElementById("oldCode");

const photo=document.getElementById("photo");
const c_name=document.getElementById("c_name");
const c_father=document.getElementById("c_father");
const c_dist=document.getElementById("c_dist");
const c_mobile=document.getElementById("c_mobile");
const c_code=document.getElementById("c_code");
const qr=document.getElementById("qr");

/* ================= MEMBER CODE ================= */
async function nextCode(){
 const {data}=await sb
  .from("JBRRMS")
  .select("member_code")
  .order("member_code",{ascending:false})
  .limit(1);

 if(!data || !data.length) return "JBRRMS0001";
 return "JBRRMS"+String(parseInt(data[0].member_code.slice(6))+1).padStart(4,"0");
}

/* ================= JOIN ================= */
async function join(){
 if(
  !name.value || !father.value || !district.value ||
  !state.value || !/^[6-9]\d{9}$/.test(mobile.value) ||
  !photoInput.files.length
 ){
  alert("पूरा सही फॉर्म भरें");
  return;
 }

 const code=await nextCode();

 const fd=new FormData();
 fd.append("file",photoInput.files[0]);
 fd.append("upload_preset","jbrms_unsigned");

 const img=await fetch(
  "https://api.cloudinary.com/v1_1/dlqr73p7j/image/upload",
  {method:"POST",body:fd}
 ).then(r=>r.json());

 if(!img.secure_url){alert("Photo upload failed");return;}

 const {error}=await sb.from("JBRRMS").insert([{
  member_code:code,
  name:name.value,
  father_name:father.value,
  district:district.value,
  state:state.value,
  mobile:mobile.value,
  photo_url:img.secure_url
 }]);

 if(error){alert("Supabase Error");return;}

 show(code);
}

/* ================= LOAD OLD ================= */
function loadOld(){
 if(oldCode.value) show(oldCode.value.trim());
}

/* ================= SHOW CARD ================= */
async function show(code){
 const {data}=await sb.from("JBRRMS").select("*").eq("member_code",code).single();
 if(!data){alert("Member not found");return;}

 joinBox.style.display="none";
 front.style.display="block";
 back.style.display="block";

 photo.src=data.photo_url;
 c_name.innerText=data.name;
 c_father.innerText="पिता: "+data.father_name;
 c_dist.innerText=data.district+", "+data.state;
 c_mobile.innerText="मोबाइल: "+data.mobile;
 c_code.innerText=data.member_code;

 qr.innerHTML="";
 new QRCode(qr,{text:data.member_code,width:360,height:360});
}

/* ================= DOWNLOAD ================= */
function download(el,name){
 html2canvas(el,{scale:2,useCORS:true}).then(c=>{
  const a=document.createElement("a");
  a.download="JBRRMS_"+name+".png";
  a.href=c.toDataURL("image/png");
  a.click();
 });
}
</script>

</body>
</html>
