<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JB RRMS Join Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#fafafa;padding:10px}
.box{max-width:650px;margin:auto;background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 8px #ccc}
input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #bbb}
button{padding:10px 15px;border:none;background:#c72e1f;color:#fff;border-radius:8px;font-size:16px}
h2{text-align:center;color:#c72e1f}
</style>
</head>

<body>

<div class="box">
  <h2>рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛<br>ЁЯУЭ рд╕рджрд╕реНрдп рдкрдВрдЬреАрдХрд░рдг рдлреЙрд░реНрдо</h2>

  <input id="name" placeholder="рдкреВрд░рд╛ рдирд╛рдо*" required>
  <input id="father" placeholder="рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо*" required>
  <input id="phone" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░*" required>
  <input id="district" placeholder="рдЬрд┐рд▓рд╛*" required>
  <input id="state" placeholder="рд░рд╛рдЬреНрдп*" required>

  <label>рдкрд╛рд╕рдкреЛрд░реНрдЯ рд╕рд╛рдЗрдЬ рдлреЛрдЯреЛ *</label>
  <input id="photo" type="file" accept="image/*">

  <button id="submitBtn">Submit</button>

  <p id="msg" style="color:green;font-weight:bold"></p>
</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, Timestamp }
  from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

const firebaseConfig = {
 apiKey:"AIzaSyBQpzc5xAvInmSCbzsZiy7TpD0OXVyij_4",
 authDomain:"jb-rrms-membership-system.firebaseapp.com",
 projectId:"jb-rrms-membership-system",
 storageBucket:"jb-rrms-membership-system.appspot.com",
 messagingSenderId:"493815911364",
 appId:"1:493815911364:web:e8f2270cf73d93dd368a91"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

document.getElementById("submitBtn").addEventListener("click", submitForm);

async function submitForm(){

  const name=document.getElementById("name").value.trim();
  const father=document.getElementById("father").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const district=document.getElementById("district").value.trim();
  const state=document.getElementById("state").value.trim();
  const photo=document.getElementById("photo").files[0];

  if(!name||!father||!phone||!district||!state||!photo){
    alert("рдХреГрдкрдпрд╛ рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рднрд░реЗрдВ");
    return;
  }

  if(phone.length!==10){
    alert("рд╕рд╣реА рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ");
    return;
  }

  const memberId = "JB"+Date.now();

  const storageRef = ref(storage,"members/"+memberId+".jpg");
  await uploadBytes(storageRef,photo);
  const photoURL = await getDownloadURL(storageRef);

  await addDoc(collection(db,"members"),{
    memberId,
    name,
    father,
    phone,
    district,
    state,
    photoURL,
    created: Timestamp.now(),
    status:"pending"
  });

  document.getElementById("msg").innerText =
   "рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрдВрдЬреАрдХрд░рдг рд╣реЛ рдЧрдпрд╛ тЬФ тАФ рдЖрдкрдХрд╛ Member ID: "+memberId;

  await generatePDF(memberId,name,father,phone,district,state,photoURL);
}

async function generatePDF(id,name,father,phone,district,state,photo){

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(16);
  pdf.text("рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛",20,15);

  pdf.setFontSize(12);
  pdf.text("Member ID Card",70,25);

  const img = await toBase64(photo);
  pdf.addImage(img,"JPEG",140,35,45,45);

  const temp=document.createElement("div");
  document.body.appendChild(temp);
  new QRCode(temp,{text:id,width:120,height:120});
  const qrImg=temp.querySelector("img").src;
  pdf.addImage(qrImg,"PNG",10,80,40,40);

  pdf.text("Member ID : "+id,20,40);
  pdf.text("Name : "+name,20,50);
  pdf.text("Father : "+father,20,60);
  pdf.text("Mobile : "+phone,20,70);
  pdf.text("District : "+district,20,90);
  pdf.text("State : "+state,20,100);

  pdf.save(id+"_JB_RRMS_IDCARD.pdf");
}

function toBase64(url){
  return fetch(url).then(r=>r.blob()).then(blob=>new Promise(res=>{
    const reader=new FileReader();
    reader.onload=()=>res(reader.result);
    reader.readAsDataURL(blob);
  }))
}

</script>

</body>
</html>
