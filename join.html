<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS тАУ Join & ID Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;background:#0e0e0e;font-family:Arial}
#joinBox{max-width:420px;background:#fff;margin:20px auto;padding:18px;border-radius:12px}
h2{text-align:center;margin:0 0 10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px}
button{background:#c69214;color:#fff;border:none;font-weight:800;border-radius:6px;cursor:pointer}
label{font-size:13px;display:block;margin:8px 0}

/* CARD */
.card{display:none;position:relative;width:1080px;height:1676px;margin:20px auto}
#front{background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png") center/cover}
#back{background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png") center/cover}

.front-title,.back-title{
position:absolute;width:100%;text-align:center;font-weight:900;
background:linear-gradient(#fff2b0,#f5c542,#d4af37);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.front-title{top:395px;font-size:58px}
.back-title{top:200px;font-size:60px}

.photo{
position:absolute;top:500px;left:390px;
width:300px;height:380px;border-radius:26px;
overflow:hidden;border:18px solid #d4af37;background:#fff
}
.photo img{width:100%;height:100%;object-fit:cover}

.details{
position:absolute;top:900px;padding-left:260px;
font-size:48px;line-height:1.6
}
#c_code{margin-top:14px;font-weight:900;letter-spacing:3px}

#qr{
position:absolute;top:380px;left:50%;
transform:translateX(-50%)
}

.card-info{
position:absolute;top:720px;left:120px;right:120px;
text-align:center;font-size:34px;line-height:1.45;color:#2b1d00
}
.card-info hr{margin:20px 0;border:1px solid #d4af37}
.disclaimer{font-size:17px;opacity:.85}

.actions{text-align:center;margin:20px}
.actions button{width:180px;margin:6px}
</style>
</head>

<body>

<!-- JOIN FORM -->
<div id="joinBox">
<h2>JBRRMS Join Form</h2>

<input id="name" placeholder="рдкреВрд░рд╛ рдирд╛рдо *">
<input id="father" placeholder="рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо">
<input id="district" placeholder="рдЬрд┐рд▓рд╛">
<input id="state" placeholder="рд░рд╛рдЬреНрдп">
<input id="post" placeholder="рдкрдж *">
<input id="mobile" placeholder="рдореЛрдмрд╛рдЗрд▓ (10 рдЕрдВрдХ) *">

<input type="file" id="photoInput" accept="image/*" hidden>
<button onclick="photoInput.click()">ЁЯУ╕ рдлреЛрдЯреЛ рдЪреБрдиреЗрдВ</button>
<div id="photoStatus"></div>

<label><input type="checkbox" id="agree"> рдирд┐рдпрдо рд╕реНрд╡реАрдХрд╛рд░</label>
<button onclick="joinNow()">Join</button>

<hr>

<input id="searchInput" placeholder="Member Code рдпрд╛ Mobile">
<button onclick="searchMember()">ЁЯЖФ ID Card рджреЗрдЦреЗрдВ</button>
</div>

<!-- FRONT CARD -->
<div id="front" class="card">
<div class="front-title">рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</div>
<div class="photo"><img id="photoFront" crossorigin="anonymous"></div>

<div class="details">
<div>рдирд╛рдо : <span id="c_name"></span></div>
<div>рдкрд┐рддрд╛ : <span id="c_father"></span></div>
<div>рдЬрд┐рд▓рд╛ : <span id="c_district"></span></div>
<div>рд░рд╛рдЬреНрдп : <span id="c_state"></span></div>
<div>рдкрдж : <span id="c_post"></span></div>
<div>рдореЛрдмрд╛рдЗрд▓ : <span id="c_mobile"></span></div>
<div id="c_code"></div>
</div>
</div>

<!-- BACK CARD -->
<div id="back" class="card">
<div class="back-title">рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</div>

<div id="qr"></div>

<div class="card-info">
<p>рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣рдорд╛рд░рд╛ рдзрд░реНрдо рд╣реИред</p>
<p>рд╕рдВрдШрд░реНрд╖ рд╣рдорд╛рд░реА рдкрд╣рдЪрд╛рди рд╣реИред</p>
<p>рдПрдХрддрд╛ рдореЗрдВ рд╣реА рд╢рдХреНрддрд┐ рд╣реИред</p>
<p>рд╕рдореНрдорд╛рди рд╕реЗ рд╣реА рд╕рдорд╛рдЬ рдЖрдЧреЗ рдмрдврд╝рддрд╛ рд╣реИред</p>
<p><b>рдкрдж рд╕реЗ рдмрдбрд╝рд╛ рд╕реНрд╡рд╛рднрд┐рдорд╛рди рд╣реЛрддрд╛ рд╣реИред</b></p>
<p>рд░рд╛рдЬрдкреВрдд рд╕рдорд╛рдЬ тАУ рд╢реМрд░реНрдп рдФрд░ рд╕рдВрд╕реНрдХрд╛рд░ред</p>
<p>рдЬрдп рднрд╡рд╛рдиреА, рдЬрдп рд░рд╛рдЬрдкреВрддрд╛рдирд╛ред</p>

<hr>

<p>ЁЯУЮ Helpline : 9166377972</p>
<p>ЁЯУз Email : jbrrms1@gmail.com</p>
<p>ЁЯМР Website : www.jbrrms.in</p>

<p class="disclaimer">
рдпрд╣ рдкрд╣рдЪрд╛рди рдкрддреНрд░ JBRRMS рдХрд╛ рдЖрдВрддрд░рд┐рдХ рд╕рджрд╕реНрдпрддрд╛ рдХрд╛рд░реНрдб рд╣реИред
рдпрд╣ рдХрд┐рд╕реА рднреА рд╕рд░рдХрд╛рд░реА, рдХрд╛рдиреВрдиреА рдпрд╛ рд╡рд┐рддреНрддреАрдп рдкрд╣рдЪрд╛рди рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИред
рджреБрд░реБрдкрдпреЛрдЧ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╕рджрд╕реНрдпрддрд╛ рд░рджреНрдж рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред
</p>
</div>
</div>

<!-- ACTIONS -->
<div class="actions">
<button onclick="showFront()">тмЕ Front</button>
<button onclick="showBack()">тЮб Back</button>
<button onclick="download()">тмЗ Download</button>
</div>

<script>
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc"
);

const el=id=>document.getElementById(id);

/* ELEMENTS */
const name=el("name"), father=el("father"), district=el("district"),
state=el("state"), post=el("post"), mobile=el("mobile"),
agree=el("agree"), photoInput=el("photoInput"),
photoStatus=el("photoStatus"), searchInput=el("searchInput");

const photoFront=el("photoFront"), c_name=el("c_name"),
c_father=el("c_father"), c_district=el("c_district"),
c_state=el("c_state"), c_post=el("c_post"),
c_mobile=el("c_mobile"), c_code=el("c_code"),
qr=el("qr"), front=el("front"), back=el("back");

let photoBlob=null, side="front", currentMemberCode="";

/* PHOTO CROP */
photoInput.onchange=e=>{
 const f=e.target.files[0]; if(!f)return;
 const img=new Image(); img.src=URL.createObjectURL(f);
 img.onload=()=>{
  const c=document.createElement("canvas");
  c.width=c.height=600;
  const m=Math.min(img.width,img.height);
  c.getContext("2d").drawImage(
   img,(img.width-m)/2,(img.height-m)/2,m,m,0,0,600,600
  );
  c.toBlob(b=>{
   photoBlob=b;
   photoStatus.textContent="Photo ready тЬЕ";
  },"image/jpeg",0.9);
 };
};

/* JOIN */
async function joinNow(){
 if(!photoBlob||!name.value||!post.value||!agree.checked)
  return alert("Form incomplete");
 if(!/^\d{10}$/.test(mobile.value))
  return alert("Mobile invalid");

 const fd=new FormData();
fd.append("file",photoBlob);
fd.append("upload_preset","jbrms_unsigned");

// ЁЯФе UNIQUE photo id (NO overwrite, NO cache issue)
fd.append(
  "public_id",
  "JBRRMS_" + mobile.value + "_" + Date.now()
);

 const up=await fetch(
  "https://api.cloudinary.com/v1_1/dlqr73p7j/image/upload",
  {method:"POST",body:fd}
 ).then(r=>r.json());

 await sb.from("JBRRMS").insert([{
  name:name.value,
  father_name:father.value,
  district:district.value,
  state:state.value,
  post:post.value,
  mobile:mobile.value,
  photo_url:up.secure_url,
  status:"Pending"
 }]);

 alert("Submitted тАУ Approval Pending");
 location.reload();
}

/* SEARCH */
async function searchMember(){
 const v=searchInput.value.trim(); if(!v)return;

 let q=sb.from("JBRRMS").select("*").eq("status","Approved");
 q=/^\d{10}$/.test(v)?q.eq("mobile",v):q.eq("member_code",v);

 const {data}=await q.limit(1).maybeSingle();
 if(!data)return alert("Approved member рдирд╣реАрдВ рдорд┐рд▓рд╛");

 currentMemberCode=data.member_code;
 photoFront.crossOrigin = "anonymous";
photoFront.src = data.photo_url + "?v=" + data.member_code + "_" + Date.now();

c_name.textContent = data.name;
c_father.textContent = data.father_name;
c_district.textContent = data.district;
c_state.textContent = data.state;
c_post.textContent = data.post;
c_mobile.textContent = data.mobile;
c_code.textContent = data.member_code;

photoFront.onload = () => {
  qr.innerHTML = "";
  new QRCode(qr,{
    text: data.member_code,
    width: 220,
    height: 220
  });

  showFront(); // ЁЯСИ рдЕрдм image load рдХреЗ рдмрд╛рдж рд╣реА рдЪрд▓реЗрдЧрд╛
};
} // тЬЕ searchMember() END

/* VIEW */
function showFront(){front.style.display="block";back.style.display="none";side="front";}
function showBack(){front.style.display="none";back.style.display="block";side="back";}

/* DOWNLOAD */
function download(){
 html2canvas(
  side==="front"?front:back,
  { scale:2, useCORS:true, imageTimeout:0 }
)
 .then(c=>{
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="JBRRMS_"+currentMemberCode+"_"+side+".png";
  a.click();
 });
}
</script>

</body>
</html>
