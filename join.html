<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>JB RRMS — Member Registration & ID Card</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:10px}
.box{background:#fff;padding:15px;border-radius:12px;max-width:500px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,.2)}
input{width:100%;padding:10px;margin-top:8px}
button{padding:10px;background:#b30000;color:#fff;border:none;border-radius:10px;width:100%;margin-top:10px}
h2{text-align:center}

/* CARD DESIGN */
.card{width:1080px;height:1678px;position:relative;margin:30px auto;background-size:cover;display:none}
.pic{position:absolute;left:80px;top:360px;width:320px;height:380px;border-radius:25px;overflow:hidden}
.pic img{width:100%;height:100%;object-fit:cover}
.txt{position:absolute;left:450px;color:#000;font-size:34px;font-weight:bold}
.qr{position:absolute;right:120px;bottom:160px}
</style>
</head>

<body>

<!-- ================= FORM ================= -->
<div class="box">
<h2>जय भवानी राष्ट्रीय राजपूत महासभा</h2>
<h3>Member Registration Form</h3>

<input id="name" placeholder="नाम">
<input id="father" placeholder="पिता का नाम">
<input id="mobile" placeholder="मोबाइल नंबर">
<input id="district" placeholder="जिला">
<input id="state" placeholder="राज्य">

<label>फोटो अपलोड करें</label>
<input type="file" id="photo">

<button onclick="register()">Submit</button>

<p id="done" style="color:green;font-weight:bold"></p>
</div>

<hr>

<!-- ================= CARD FRONT ================= -->
<div id="front" class="card" style="background-image:url('https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png')">

<div class="pic"><img id="photo_img"></div>

<div class="txt" style="top:820px">नाम: <span id="name_t"></span></div>
<div class="txt" style="top:890px">पिता का नाम: <span id="father_t"></span></div>
<div class="txt" style="top:960px">जिला: <span id="district_t"></span></div>
<div class="txt" style="top:1030px">राज्य: <span id="state_t"></span></div>
<div class="txt" style="top:1100px">Member Code: <span id="mcode_t"></span></div>

<canvas id="qr1" class="qr" width="220" height="220"></canvas>

</div>

<!-- ================= CARD BACK ================= -->
<div id="back" class="card" style="background-image:url('https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png')">
<canvas id="qr2" class="qr" width="220" height="220"></canvas>
</div>

<div style="text-align:center">
<button onclick="downloadBoth()">Download Front & Back</button>
</div>


<script>
// ================= Supabase =================
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// ================= Cloudinary =================
const cloudName = "dlqr73p7j";
const preset = "jbrms_unsigned";

// FACE API
Promise.all([
 faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights")
]);


// ===== GET NEXT MEMBER CODE =====
async function getNextCode(){

 let {data}=await supabaseClient
  .from("JBRRMS")
  .select("member_code")
  .order("member_code",{ascending:false})
  .limit(1);

 if(!data || data.length===0) return "JBRRMS0001";

 let last=data[0].member_code.replace("JBRRMS","");
 let next=(parseInt(last)+1).toString().padStart(4,"0");

 return "JBRRMS"+next;
}


// ===== FACE AUTO CROP =====
async function cropPhoto(file){

 const img = new Image();
 img.src = URL.createObjectURL(file);
 await img.decode();

 const det = await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions());

 const c=document.createElement("canvas");
 c.width=600;c.height=600;
 const ctx=c.getContext("2d");

 ctx.fillStyle="#eef3ff";
 ctx.fillRect(0,0,600,600);

 ctx.save();
 ctx.beginPath();
 ctx.roundRect(20,20,560,560,30);
 ctx.clip();

 let sx=0,sy=0,sw=img.width,sh=img.height;

 if(det){
   let b=det.box;
   sx=Math.max(0,b.x-b.width*0.5);
   sy=Math.max(0,b.y-b.height*0.5);
   sw=Math.min(img.width-sx,b.width*2);
   sh=Math.min(img.height-sy,b.height*2);
 }

 ctx.drawImage(img,sx,sy,sw,sh,0,0,600,600);
 ctx.restore();

 return await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
}


// ===== CLOUDINARY UPLOAD =====
async function upload(file,name){
 const fd=new FormData();
 fd.append("file",file);
 fd.append("upload_preset",preset);
 fd.append("public_id",name);

 let r=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,{
   method:"POST",body:fd
 });

 let j=await r.json();
 return j.secure_url;
}


// ===== REGISTER MEMBER =====
async function register(){

 let n=name.value,f=father.value,m=mobile.value,d=district.value,s=state.value;

 if(!n||!f||!m||!d||!s){alert("सब फील्ड भरें");return;}

 let file=photo.files[0];
 if(!file){alert("फोटो अपलोड करें");return;}

 let member_code = await getNextCode();

 let blob=await cropPhoto(file);
 let url=await upload(blob,member_code);

 let {error}=await supabaseClient.from("JBRRMS").insert([
   {member_code,name:n,father_name:f,mobile:m,district:d,state:s,photo_url:url}
 ]);

 if(error){alert("Database Error");return;}

 done.innerText="✔ Registration Successful — Member Code: "+member_code;

 showCard({name:n,father_name:f,district:d,state:s,member_code,photo_url:url});
}


// ===== SHOW CARD =====
function showCard(d){

 document.getElementById("front").style.display="block";
 document.getElementById("back").style.display="block";

 name_t.innerText=d.name;
 father_t.innerText=d.father_name;
 district_t.innerText=d.district;
 state_t.innerText=d.state;
 mcode_t.innerText=d.member_code;
 photo_img.src=d.photo_url;

 QRCode.toCanvas(document.getElementById("qr1"), d.member_code,{width:220});
 QRCode.toCanvas(document.getElementById("qr2"), d.member_code,{width:220});
}


// ===== DOWNLOAD BOTH =====
async function downloadBoth(){

 const f = await html2canvas(front);
 const b = await html2canvas(back);

 let link1=document.createElement("a");
 link1.download="Front_ID.png";
 link1.href=f.toDataURL();
 link1.click();

 let link2=document.createElement("a");
 link2.download="Back_ID.png";
 link2.href=b.toDataURL();
 link2.click();
}
</script>

</body>
</html>
