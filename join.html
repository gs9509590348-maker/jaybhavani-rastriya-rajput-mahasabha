<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JB RRMS Join Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#fafafa;padding:10px}
.box{max-width:650px;margin:auto;background:#fff;padding:15px;border-radius:10px;
box-shadow:0 0 8px #ccc}
input,select{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #bbb}
button{padding:10px 15px;border:none;background:#c72e1f;color:#fff;
border-radius:8px;font-size:16px}
h2{text-align:center;color:#c72e1f}
</style>
</head>

<body>
<div class="box">
  <h2>рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛<br>ЁЯУЭ рд╕рджрд╕реНрдп рдкрдВрдЬреАрдХрд░рдг рдлреЙрд░реНрдо</h2>

  <input id="name" placeholder="рдкреВрд░рд╛ рдирд╛рдо*" required>
  <input id="father" placeholder="рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо*" required>
  <input id="phone" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░*" required>
  <input id="district" placeholder="рдЬрд┐рд▓рд╛*" required>
  <input id="state" placeholder="рд░рд╛рдЬреНрдп*" required>

  <label>рдкрд╛рд╕рдкреЛрд░реНрдЯ рд╕рд╛рдЗрдЬ рдлреЛрдЯреЛ *</label>
  <input id="photo" type="file" accept="image/*">

  <button onclick="submitForm()">Submit</button>

  <p id="msg" style="color:green;font-weight:bold"></p>
</div>

<script type="module">
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, Timestamp }
  from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_APP.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

window.submitForm = async function(){

  const name=document.getElementById("name").value;
  const father=document.getElementById("father").value;
  const phone=document.getElementById("phone").value;
  const district=document.getElementById("district").value;
  const state=document.getElementById("state").value;
  const photo=document.getElementById("photo").files[0];

  if(!name||!father||!phone||!district||!state||!photo){
    alert("рдХреГрдкрдпрд╛ рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рднрд░реЗрдВ");
    return;
  }

  // ЁЯФ╣ Auto Member ID
  const memberId = "JB"+Date.now();

  // ЁЯФ╣ Upload Photo
  const storageRef = ref(storage,"members/"+memberId+".jpg");
  await uploadBytes(storageRef,photo);
  const photoURL = await getDownloadURL(storageRef);

  // ЁЯФ╣ Save to Firestore
  await addDoc(collection(db,"members"),{
    memberId,
    name,
    father,
    phone,
    district,
    state,
    photoURL,
    created: Timestamp.now(),
    status:"pending"
  });

  document.getElementById("msg").innerText =
   "рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрдВрдЬреАрдХрд░рдг рд╣реЛ рдЧрдпрд╛ тЬФ тАФ рдЖрдкрдХрд╛ Member ID: "+memberId;

  // ЁЯФ╣ Generate PDF ID Card
  await generatePDF(memberId,name,father,phone,district,state,photoURL);
}


// ========== PDF GENERATOR ==========
async function generatePDF(id,name,father,phone,district,state,photo){

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  // Title
  pdf.setFontSize(16);
  pdf.text("рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛",20,15);

  pdf.setFontSize(12);
  pdf.text("Member ID Card",70,25);

  // Photo
  const img = await toBase64(photo);
  pdf.addImage(img,"JPEG",140,35,45,45);

  // QR
  const temp=document.createElement("div");
  new QRCode(temp,{text:id,width:120,height:120});
  const qrImg=temp.querySelector("img").src;
  pdf.addImage(qrImg,"PNG",10,80,40,40);

  // Details
  pdf.text("Member ID : "+id,20,40);
  pdf.text("Name : "+name,20,50);
  pdf.text("Father : "+father,20,60);
  pdf.text("Mobile : "+phone,20,70);
  pdf.text("District : "+district,20,90);
  pdf.text("State : "+state,20,100);

  pdf.save(id+"_JB_RRMS_IDCARD.pdf");
}

// Convert image url тЖТ base64
function toBase64(url){
  return fetch(url).then(r=>r.blob()).then(blob=>new Promise(res=>{
    const reader=new FileReader();
    reader.onload=()=>res(reader.result);
    reader.readAsDataURL(blob);
  }))
}

</script>
</body>
</html>
