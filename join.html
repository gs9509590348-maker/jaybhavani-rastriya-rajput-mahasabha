<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Join + ID Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<!-- Download -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  background:#111;
  font-family:Arial,sans-serif;
}

/* ===== JOIN FORM ===== */
#joinBox{
  max-width:360px;
  background:#fff;
  margin:40px auto;
  padding:20px;
  border-radius:8px;
}
#joinBox h2{text-align:center}
input,button{
  width:100%;
  padding:10px;
  margin:8px 0;
}
button{
  background:#e65100;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:disabled{background:#999}

/* ===== CARD COMMON ===== */
.card{
  display:none;
  position:relative;
  width:1080px;
  height:1676px;
  margin:40px auto;
  background-size:cover;
  background-position:center;
}

/* ===== FRONT ===== */
#front{
  background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png") no-repeat center/cover;
}
.photo{
  position:absolute;
  top:360px;
  left:390px;
  width:300px;
  height:380px;
  border-radius:24px;
  overflow:hidden;
  border:10px solid #d4af37;
  background:#fff;
}
.photo img{width:100%;height:100%;object-fit:cover}

.details{
  position:absolute;
  top:780px;
  width:100%;
  text-align:center;
  color:#000;
}
#c_name{font-size:42px;font-weight:bold}
#c_district{font-size:34px;margin-top:6px}
#c_code{font-size:30px;margin-top:8px;letter-spacing:2px}

/* ===== BACK ===== */
#back{
  background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png") no-repeat center/cover;
}
#qr{
  position:absolute;
  bottom:260px;
  left:390px;
}
.backtext{
  position:absolute;
  bottom:120px;
  width:100%;
  text-align:center;
  font-size:26px;
  color:#000;
}

/* ===== BUTTONS ===== */
.actions{
  text-align:center;
  margin-bottom:60px;
}
</style>
</head>

<body>

<!-- ================= JOIN FORM ================= -->
<div id="joinBox">
  <h2>JBRRMS Join Form</h2>
  <input id="name" placeholder="पूरा नाम" required>
  <input id="district" placeholder="जिला" required>
  <input id="mobile" placeholder="मोबाइल नंबर" pattern="[0-9]{10}" required>
  <input type="file" id="photoInput" accept="image/*" required>
  <button id="joinBtn">Join Now</button>
</div>

<!-- ================= FRONT ================= -->
<div id="front" class="card">
  <div class="photo">
    <img id="photo">
  </div>
  <div class="details">
    <div id="c_name"></div>
    <div id="c_district"></div>
    <div id="c_code"></div>
  </div>
</div>

<!-- ================= BACK ================= -->
<div id="back" class="card">
  <div id="qr"></div>
  <div class="backtext">
    हेल्पलाइन: 9166377972<br>
    Email: jbrrms1@gmail.com<br>
    Website: www.jbrrms.in
  </div>
</div>

<div class="actions">
  <button onclick="downloadFront()">⬇️ Download Front</button>
  <button onclick="downloadBack()">⬇️ Download Back</button>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://ejdzdptqxelilkseannw.supabase.co",
  "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P"
);

let finalPhotoBlob=null;

/* ===== MEMBER CODE ===== */
async function generateMemberCode(){
  const {data} = await sb
    .from("JBRRMS")
    .select("member_code")
    .order("member_code",{ascending:false})
    .limit(1);

  if(!data || data.length===0) return "JBRRMS0001";
  let n=parseInt(data[0].member_code.replace("JBRRMS",""))+1;
  return "JBRRMS"+String(n).padStart(4,"0");
}

/* ===== PHOTO PROCESS ===== */
photoInput.onchange=e=>{
  const img=new Image();
  img.src=URL.createObjectURL(e.target.files[0]);
  img.onload=()=>{
    const c=document.createElement("canvas");
    c.width=c.height=600;
    const x=c.getContext("2d");
    const s=Math.min(img.width,img.height);
    x.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,600,600);
    c.toBlob(b=>finalPhotoBlob=b,"image/jpeg",0.9);
  }
}

/* ===== JOIN ===== */
joinBtn.onclick=async()=>{
  if(!finalPhotoBlob) return alert("Photo upload करें");
  joinBtn.disabled=true;

  const code=await generateMemberCode();

  // Cloudinary
  const fd=new FormData();
  fd.append("file",finalPhotoBlob);
  fd.append("upload_preset","jbrms_unsigned");

  const up=await fetch("https://api.cloudinary.com/v1_1/dlqr73p7j/image/upload",{method:"POST",body:fd});
  const img=await up.json();

  await sb.from("JBRRMS").insert([{
    member_code:code,
    name:name.value,
    district:district.value,
    mobile:mobile.value,
    photo_url:img.secure_url
  }]);

  showCard(code);
}

/* ===== SHOW CARD ===== */
async function showCard(code){
  joinBox.style.display="none";
  front.style.display="block";
  back.style.display="block";

  const {data}=await sb.from("JBRRMS").select("*").eq("member_code",code).single();

  c_name.innerText=data.name;
  c_district.innerText=data.district;
  c_code.innerText=data.member_code;
  photo.src=data.photo_url;

  qr.innerHTML="";
  new QRCode(qr,{
    text:data.member_code,
    width:300,
    height:300
  });
}

/* ===== DOWNLOAD ===== */
function downloadFront(){
  html2canvas(front,{scale:2}).then(c=>{
    const a=document.createElement("a");
    a.download="JBRRMS_FRONT.png";
    a.href=c.toDataURL();
    a.click();
  });
}
function downloadBack(){
  html2canvas(back,{scale:2}).then(c=>{
    const a=document.createElement("a");
    a.download="JBRRMS_BACK.png";
    a.href=c.toDataURL();
    a.click();
  });
}
</script>

</body>
</html>
