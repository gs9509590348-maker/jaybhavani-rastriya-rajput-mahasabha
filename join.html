<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>JB RRMS Member Registration</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 10px #ccc;max-width:600px;margin:auto}
input{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:5px}
button{background:#007bff;color:#fff;border:0;padding:10px;border-radius:5px;width:100%;font-size:16px}
</style>
</head>

<body>

<div class="card">
<h2>JB RRMS — सदस्य पंजीकरण</h2>

<input id="name" placeholder="नाम लिखें" />
<input id="father_name" placeholder="पिता का नाम लिखें" />
<input id="district" placeholder="जिला लिखें" />
<input id="state" placeholder="राज्य लिखें" />
<input id="mobile" placeholder="मोबाइल नंबर" />

<label>फोटो अपलोड करें</label>
<input type="file" id="photo" accept="image/*" />

<button onclick="saveMember()">Register Member</button>

<p id="msg" style="font-weight:bold"></p>
</div>

<script>
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Member Code Generate Function
async function generateMemberCode(){
  const { count, error } = await supabaseClient
    .from("JBRRMS")
    .select("*", { count: "exact", head: true });

  if(error){
    console.log("COUNT ERROR:", error);
    return "JBRRMS0001";
  }

  let num = (count || 0) + 1;
  return "JBRRMS" + String(num).padStart(4, "0");
}

async function saveMember(){

 document.getElementById("msg").innerText = "Saving, please wait...";

 const name = document.getElementById("name").value.trim();
 const father = document.getElementById("father_name").value.trim();
 const district = document.getElementById("district").value.trim();
 const state = document.getElementById("state").value.trim();
 const mobile = document.getElementById("mobile").value.trim();
 const photoFile = document.getElementById("photo").files[0];

 if(!name || !mobile || !photoFile){
   alert("नाम, मोबाइल और फोटो जरूरी है");
   return;
 }

 const member_code = await generateMemberCode();

 // फोटो Upload
 const ext = photoFile.name.split(".").pop();
 const fileName = `${member_code}_${Date.now()}.${ext}`;

 const { data: uploadData, error: uploadError } = await supabaseClient
   .storage
   .from("members")
   .upload(fileName, photoFile, {
     contentType: photoFile.type,
     cacheControl: "3600",
     upsert: true
   });

 if(uploadError){
   alert("Photo upload failed");
   console.log("UPLOAD ERROR:", uploadError);
   return;
 }

 // Public URL
 const { data: publicUrlData } = supabaseClient
   .storage
   .from("members")
   .getPublicUrl(fileName);

 const photo_url = publicUrlData.publicUrl;

 // Database Insert
 const { data, error } = await supabaseClient
   .from("JBRRMS")
   .insert({
     member_code,
     name,
     father_name: father,
     district,
     state,
     mobile,
     photo_url
   })
   .select();

 if(error){
   console.log("DB ERROR:", error);
   alert("DB ERROR: " + error.message);
   return;
 }

 document.getElementById("msg").innerText =
   "सदस्य सफलतापूर्वक रजिस्टर हुआ ✔ कोड: " + member_code;

 alert("सदस्य सफलतापूर्वक रजिस्टर हुआ ✔ Member Code: " + member_code);
}
</script>

</body>
</html>
