<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JB RRMS тАУ Final Digital System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Mangal,Arial;background:#f2f2f2;margin:0;padding:10px}
.section{background:#fff;padding:12px;border-radius:8px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:16px}
button{background:#8b0000;color:#fff;border:none;border-radius:6px}
canvas{width:100%;max-width:1080px;border:2px solid #aaa;margin-top:10px;background:#fff}
h2,h3{text-align:center}
</style>
</head>

<body>

<h2>рдЬрдп рднрд╡рд╛рдиреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рд░рд╛рдЬрдкреВрдд рдорд╣рд╛рд╕рднрд╛</h2>

<div class="section">
<h3>ЁЯФН Member Code рд╕реЗ рд╕рд░реНрдЪ</h3>
<input id="searchCode" placeholder="JBRRMS0001">
<button onclick="searchMember()">Search & Generate</button>
</div>

<canvas id="certificate" width="1080" height="1678"></canvas>
<canvas id="idFront" width="1080" height="1678"></canvas>
<canvas id="idBack" width="1080" height="1678"></canvas>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL="https://ejdzdptqxelilkseannw.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHpkcHRxeGVsaWxrc2Vhbm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTE2MTYsImV4cCI6MjA4MzI4NzYxNn0.j3V1D7Ha2SlKwM9cCCHXlFOzAACQZQ4PVXBIkLq4_cc";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let member={};

/* ===== TEMPLATES ===== */
const certBG=new Image();
certBG.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/certificate.png";

const idFrontBG=new Image();
idFrontBG.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png";

const idBackBG=new Image();
idBackBG.src="https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png";

/* ===== SEARCH ===== */
async function searchMember(){
 const code=searchCode.value.trim();
 if(!code){alert("Member Code рдбрд╛рд▓реЗрдВ");return;}

 const {data,error}=await supabase
  .from("members")
  .select("*")
  .eq("member_code",code)
  .single();

 if(error||!data){alert("Member рдирд╣реАрдВ рдорд┐рд▓рд╛");return;}
 member=data;
 generateAll();
}

/* ===== GENERATE ALL ===== */
function generateAll(){
 generateCertificate();
 generateID();
}

/* ===== CERTIFICATE (NO PHOTO) ===== */
function generateCertificate(){
 const c=certificate.getContext("2d");
 c.clearRect(0,0,1080,1678);
 c.drawImage(certBG,0,0,1080,1678);

 c.textAlign="center";
 c.fillStyle="#7a0000";
 c.font="bold 60px serif";
 c.fillText("рдкреНрд░рдорд╛рдг рдкрддреНрд░",540,360);

 c.font="32px serif";
 c.fillStyle="#000";
 c.textAlign="left";

 let y=520,g=60;
 drawLine("рдирд╛рдо",member.name);
 drawLine("рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо",member.father_name);
 drawLine("рдореЛрдмрд╛рдЗрд▓",member.mobile);
 drawLine("рдЬрд┐рд▓рд╛",member.district);
 drawLine("рд░рд╛рдЬреНрдп",member.state);
 drawLine("рд╕рджрд╕реНрдп рдХреЛрдб",member.member_code);

 function drawLine(l,v){
  c.fillText(l+" :",220,y);
  c.textAlign="right";
  c.fillText(v||"",860,y);
  c.textAlign="left";
  y+=g;
 }

 /* LEFT SIDE INFO */
 c.save();
 c.translate(90,1150);
 c.rotate(-Math.PI/2);
 c.font="22px serif";
 c.fillText("рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди : 9166377972",0,0);
 c.fillText("рдИрдореЗрд▓ : jbrrms1@gmail.com",0,32);
 c.fillText("рд╡реЗрдмрд╕рд╛рдЗрдЯ : www.jbrrms.in",0,64);
 c.restore();

 /* QR RIGHT (fine-tuned) */
 drawQR(c,760,980,qrURL());

 /* DISCLAIMER */
 c.font="18px serif";
 c.textAlign="center";
 c.fillText(
  "рдпрд╣ рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдХреЗрд╡рд▓ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдкрд╣рдЪрд╛рди рд╣реЗрддреБ рд╣реИред рдЗрд╕рдХрд╛ рдХрд┐рд╕реА рднреА рд╕рд░рдХрд╛рд░реА рдЕрдзрд┐рдХрд╛рд░ рд╕реЗ рд╕рдВрдмрдВрдз рдирд╣реАрдВ рд╣реИред",
 540,1600
 );
}

/* ===== ID CARD ===== */
function generateID(){
 /* FRONT */
 const f=idFront.getContext("2d");
 f.clearRect(0,0,1080,1678);
 f.drawImage(idFrontBG,0,0,1080,1678);

 if(member.photo_url){
  const img=new Image();
  img.onload=()=>f.drawImage(img,360,420,360,460);
  img.src=member.photo_url;
 }

 f.font="28px serif";
 f.fillStyle="#000";
 f.fillText(member.name||"",360,950);
 f.fillText(member.member_code||"",360,1000);
 f.fillText(member.district||"",360,1050);

 /* BACK */
 const b=idBack.getContext("2d");
 b.clearRect(0,0,1080,1678);
 b.drawImage(idBackBG,0,0,1080,1678);

 drawQR(b,420,520,qrURL());

 b.font="24px serif";
 b.textAlign="center";
 b.fillText("рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди : 9166377972",540,1200);
 b.fillText("рдИрдореЗрд▓ : jbrrms1@gmail.com",540,1250);
 b.fillText("рд╡реЗрдмрд╕рд╛рдЗрдЯ : www.jbrrms.in",540,1300);

 b.font="18px serif";
 b.fillText("рдпрд╣ рдХрд╛рд░реНрдб рдХреЗрд╡рд▓ рд╕рдВрдЧрдардирд╛рддреНрдордХ рдкрд╣рдЪрд╛рди рд╣реЗрддреБ рд╣реИред",540,1360);
}

/* ===== QR ===== */
function qrURL(){
 return "https://www.jbrrms.in/?member="+member.member_code;
}
function drawQR(ctx,x,y,text){
 QRCode.toCanvas(document.createElement("canvas"),text,{width:240},(e,qr)=>{
  ctx.drawImage(qr,x,y);
 });
}
</script>

</body>
</html>
