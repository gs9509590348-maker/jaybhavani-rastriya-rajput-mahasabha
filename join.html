<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JB RRMS Member Registration</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 10px #ccc;max-width:600px;margin:auto}
input,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:5px}
button{background:#007bff;color:#fff;border:0;padding:10px;border-radius:5px;width:100%;font-size:16px}
</style>
</head>

<body>

<div class="card">
<h2>JB RRMS â€” Member Registration</h2>

<input id="name" placeholder="à¤¨à¤¾à¤®" />
<input id="father_name" placeholder="à¤ªà¤¿à¤¤à¤¾ à¤•à¤¾ à¤¨à¤¾à¤®" />
<input id="district" placeholder="à¤œà¤¿à¤²à¤¾" />
<input id="state" placeholder="à¤°à¤¾à¤œà¥à¤¯" />
<input id="mobile" placeholder="à¤®à¥‹à¤¬à¤¾à¤‡à¤² à¤¨à¤‚à¤¬à¤°" />
<input id="post" placeholder="à¤ªà¤¦" />

<label>à¤«à¥‹à¤Ÿà¥‹ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚</label>
<input type="file" id="photo" accept="image/*" />

<button onclick="saveMember()">Register Member</button>

<p id="msg"></p>
</div>

<script>
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// âœ… Table name = JBRRMS
async function generateMemberCode(){
  const { count, error } = await supabaseClient
    .from("JBRRMS")
    .select("*", { count: "exact", head: true });

  let num = (count || 0) + 1;

  return "JBRRMS" + String(num).padStart(4, "0");
}

async function saveMember(){

 document.getElementById("msg").innerText = "Saving, please wait...";

 const name = document.getElementById("name").value;
 const father = document.getElementById("father_name").value;
 const district = document.getElementById("district").value;
 const state = document.getElementById("state").value;
 const mobile = document.getElementById("mobile").value;
 const post = document.getElementById("post").value;
 const photoFile = document.getElementById("photo").files[0];

 if(!name || !mobile || !photoFile){
   alert("à¤¨à¤¾à¤®, à¤®à¥‹à¤¬à¤¾à¤‡à¤² à¤”à¤° à¤«à¥‹à¤Ÿà¥‹ à¤œà¤°à¥‚à¤°à¥€ à¤¹à¥ˆ");
   return;
 }

 const member_code = await generateMemberCode();

 // ðŸ“¸ à¤«à¥‹à¤Ÿà¥‹ upload bucket name = members
 const fileName = member_code + "_" + Date.now() + ".jpg";

 const { error: uploadError } = await supabaseClient
   .storage
   .from("members")
   .upload(fileName, photoFile, {
      cacheControl: "3600",
      upsert: false
   });

 if(uploadError){
   alert("Photo upload failed");
   console.log(uploadError);
   return;
 }

 const photo_url = `${supabaseUrl}/storage/v1/object/public/members/${fileName}`;

 // ðŸ§¾ Insert into JBRRMS table
 const { error } = await supabaseClient
   .from("JBRRMS")
   .insert({
     member_code,
     name,
     father_name: father,
     district,
     state,
     mobile,
     post,
     photo_url
   });

 if(error){
   alert("Error saving data");
   console.log(error);
   return;
 }

 document.getElementById("msg").innerText = 
   "Member Registered Successfully âœ” Member Code: " + member_code;

 alert("Member Registered Successfully âœ” Member Code: " + member_code);
}
</script>

</body>
</html>
