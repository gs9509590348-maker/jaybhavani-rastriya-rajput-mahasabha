<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
 apiKey:"AIzaSyBQpzc5xAvInmSCbzsZiy7TpD0OXVyij_4",
 authDomain:"jb-rrms-membership-system.firebaseapp.com",
 projectId:"jb-rrms-membership-system",
 storageBucket:"jb-rrms-membership-system.appspot.com",
 messagingSenderId:"493815911364",
 appId:"1:493815911364:web:e8f2270cf73d93dd368a91"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

joinBtn.onclick = async ()=>{

 const name = document.getElementById("name").value.trim();
 const father = document.getElementById("father").value.trim();
 const mobile = document.getElementById("mobile").value.trim();
 const state = document.getElementById("state").value.trim();
 const district = document.getElementById("district").value.trim();
 const address = document.getElementById("address").value.trim();
 const photoFile = document.getElementById("photo").files[0];
 const msg = document.getElementById("msg");

 const role = "рд╕рджрд╕реНрдп";

 if(!name || !father || !mobile || !state || !district || !address){
  alert("рдХреГрдкрдпрд╛ рд╕рднреА рд╡рд┐рд╡рд░рдг рднрд░реЗрдВ");
  return;
 }

 if(mobile.length!=10){
  alert("рд╕рд╣реА рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВ");
  return;
 }

 if(!photoFile){
  alert("рдХреГрдкрдпрд╛ рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ");
  return;
 }

 msg.style.color="blue";
 msg.innerText="рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ...";

 try {

  const q1 = query(collection(db,"approved_members"), where("mobile","==",mobile));
  const r1 = await getDocs(q1);

  const q2 = query(collection(db,"pending_members"), where("mobile","==",mobile));
  const r2 = await getDocs(q2);

  if(!r1.empty || !r2.empty){
   msg.style.color="red";
   msg.innerText="рдпрд╣ рдореЛрдмрд╛рдЗрд▓ рдкрд╣рд▓реЗ рд╕реЗ Registered рд╣реИ ЁЯЪл";
   return;
  }

  const photoRef = ref(storage, "member_photos/"+mobile+".jpg");
  await uploadBytes(photoRef, photoFile);
  const photoURL = await getDownloadURL(photoRef);

  await addDoc(collection(db,"pending_members"),{
   name,
   father,
   mobile,
   state,
   district,
   address,
   photo: photoURL,
   role,
   status:"pending",
   created:new Date()
  });

  msg.style.color="green";
  msg.innerText="рдЖрдкрдХрд╛ рдлреЙрд░реНрдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдмрдорд┐рдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИ ЁЯЩП";

 } catch(e){
  console.log(e);
  msg.style.color="red";
  msg.innerText="рд╕рдмрдорд┐рдЯ рдХрд░рддреЗ рд╕рдордп рд╕рдорд╕реНрдпрд╛ рдЖрдИ тЭМ";
 }

};

</script>
