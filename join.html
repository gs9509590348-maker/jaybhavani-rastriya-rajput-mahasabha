<!DOCTYPE html>
<html lang="hi">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>JBRRMS Member Registration</title>

<script defer src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

<style>
body{font-family:Arial;padding:15px;background:#f5f5f5}
.card{background:#fff;padding:15px;border-radius:10px;max-width:500px;margin:auto}
input{width:100%;padding:10px;margin:8px 0}
button{padding:10px 15px;background:#0077ff;color:#fff;border:0;border-radius:5px;width:100%}
#msg{margin-top:10px;font-weight:bold;white-space:pre-line}
</style>
</head>

<body>

<div class="card">
  <h2>JBRRMS Member Registration</h2>

  <input id="name" placeholder="नाम" />
  <input id="father_name" placeholder="पिता का नाम" />
  <input id="district" placeholder="जिला" />
  <input id="state" placeholder="राज्य" />
  <input id="mobile" placeholder="मोबाइल नंबर" />
  <input id="photo" type="file" accept="image/*" />

  <button onclick="saveMember()">Save Member</button>

  <div id="msg"></div>
</div>

<script>
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";

const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

async function saveMember(){

  const name = document.getElementById("name").value.trim();
  const father_name = document.getElementById("father_name").value.trim();
  const district = document.getElementById("district").value.trim();
  const state = document.getElementById("state").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const photoFile = document.getElementById("photo").files[0];

  const msg = document.getElementById("msg");
  msg.innerText = "Saving...";

  if(!name || !mobile || !photoFile){
    msg.innerText = "कृपया नाम, मोबाइल और फोटो जरूरी भरें";
    return;
  }

  // FILE NAME (bucket/members/photos)
  const fileName = `photos/${Date.now()}_${photoFile.name}`;

  // UPLOAD PHOTO
  const { error: uploadError } = await supabase
    .storage
    .from("members")
    .upload(fileName, photoFile);

  if(uploadError){
    msg.innerText = "Photo Upload Error ❌";
    console.log(uploadError);
    return;
  }

  // PUBLIC URL
  const { data } = supabase
    .storage
    .from("members")
    .getPublicUrl(fileName);

  const photo_url = data.publicUrl;

  // INSERT INTO DATABASE
  const { error: insertError } = await supabase
    .from("JBRRMS")
    .insert([
      { name, father_name, district, state, mobile, photo_url }
    ]);

  if(insertError){
    msg.innerText = "Database Error ❌";
    console.log(insertError);
    return;
  }

  msg.innerText = "✔ Member Saved Successfully";

  document.getElementById("name").value = "";
  document.getElementById("father_name").value = "";
  document.getElementById("district").value = "";
  document.getElementById("state").value = "";
  document.getElementById("mobile").value = "";
  document.getElementById("photo").value = "";
}

window.saveMember = saveMember;
</script>

</body>
</html>
