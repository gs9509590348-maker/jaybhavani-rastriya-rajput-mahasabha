<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JB RRMS Member Registration</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f5f5f5;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 10px #ccc;max-width:600px;margin:auto}
input,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:5px}
button{background:#007bff;color:#fff;border:0;padding:10px;border-radius:5px;width:100%;font-size:16px}
</style>
</head>

<body>

<div class="card">
<h2>JB RRMS ‚Äî Member Registration</h2>

<input id="name" placeholder="‡§®‡§æ‡§Æ" />
<input id="father_name" placeholder="‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ" />
<input id="district" placeholder="‡§ú‡§ø‡§≤‡§æ" />
<input id="state" placeholder="‡§∞‡§æ‡§ú‡•ç‡§Ø" />
<input id="mobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" />
<input id="post" placeholder="‡§™‡§¶" />

<label>‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</label>
<input type="file" id="photo" accept="image/*" />

<button onclick="saveMember()">Register Member</button>

<p id="msg"></p>
</div>

<script>
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function generateMemberCode(){
  const { data, error } = await supabaseClient
    .from("members")
    .select("member_code", { count: "exact" });

  let num = (data?.length || 0) + 1;
  return "JBRRMS" + String(num).padStart(4, "0");
}

async function saveMember(){

 document.getElementById("msg").innerText = "Saving, please wait...";

 const name = document.getElementById("name").value;
 const father = document.getElementById("father_name").value;
 const district = document.getElementById("district").value;
 const state = document.getElementById("state").value;
 const mobile = document.getElementById("mobile").value;
 const post = document.getElementById("post").value;
 const photoFile = document.getElementById("photo").files[0];

 if(!name || !mobile || !photoFile){
   alert("‡§®‡§æ‡§Æ, ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§î‡§∞ ‡§´‡•ã‡§ü‡•ã ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à");
   return;
 }

 const member_code = await generateMemberCode();

 // üì∏ Upload Photo
 const fileName = member_code + "_" + Date.now() + ".jpg";

 const { data: upload, error: uploadError } = await supabaseClient
   .storage
   .from("members")     // ‚ö†Ô∏è ‡§Ø‡§π‡•Ä ‡§Ü‡§™‡§ï‡§æ bucket name ‡§π‡•à
   .upload(fileName, photoFile, {
      cacheControl: "3600",
      upsert: false
   });

 if(uploadError){
   alert("Photo upload failed");
   console.log(uploadError);
   return;
 }

 const photo_url = supabaseUrl + "/storage/v1/object/public/members/" + fileName;

 // üßæ Save Data
 const { data, error } = await supabaseClient
   .from("members")
   .insert([{
     member_code,
     name,
     father_name: father,
     district,
     state,
     mobile,
     post,
     photo_url
   }]);

 if(error){
   alert("Error saving data");
   console.log(error);
   return;
 }

 document.getElementById("msg").innerText = 
   "Member Registered Successfully ‚úî Member Code: " + member_code;
 alert("Member Registered Successfully ‚úî Member Code: " + member_code);
}
</script>

</body>
</html>
