<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>JBRRMS Join + ID Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;background:#111;font-family:Arial}
#joinBox{max-width:380px;background:#fff;margin:30px auto;padding:20px;border-radius:8px}
input,button{width:100%;padding:10px;margin:7px 0;font-size:16px}
button{background:#e65100;color:#fff;border:none;border-radius:4px}

/* CARD */
.card{
 display:none;
 width:1080px;height:1676px;
 margin:30px auto;position:relative;
 background-size:cover;
}

/* FRONT */
#front{
 background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_front.png?v=FINAL") center/cover no-repeat;
}
.photo{
 position:absolute;top:360px;left:390px;
 width:300px;height:380px;
 border-radius:24px;overflow:hidden;
 border:10px solid #d4af37;
}
.photo img{width:100%;height:100%;object-fit:cover}

.details{position:absolute;top:780px;width:100%;text-align:center;color:#000}
#c_name{font-size:42px;font-weight:bold}
#c_post{font-size:30px}
#c_dist{font-size:28px}
#c_code{font-size:30px}

/* BACK */
#back{
 background:url("https://ejdzdptqxelilkseannw.supabase.co/storage/v1/object/public/members/idcard_back.png?v=FINAL") center/cover no-repeat;
}
#qr{position:absolute;bottom:260px;left:390px}
.backtext{position:absolute;bottom:120px;width:100%;text-align:center;font-size:26px}

.actions{text-align:center;margin-bottom:40px}
</style>
</head>

<body>

<!-- JOIN FORM -->
<div id="joinBox">
<h3>JBRRMS Join Form</h3>

<input id="name" placeholder="पूरा नाम">
<input id="father" placeholder="पिता का नाम">
<input id="district" placeholder="जिला">
<input id="state" placeholder="राज्य">
<input id="mobile" placeholder="मोबाइल (10 अंक)">
<input id="post" placeholder="पद">
<input type="file" id="photoInput" accept="image/*">

<button onclick="join()">Submit</button>

<hr>

<input id="oldCode" placeholder="पुराना Member Code">
<button onclick="loadOld()">Old Data Load</button>
</div>

<!-- FRONT CARD -->
<div id="front" class="card">
 <div class="photo"><img id="photo"></div>
 <div class="details">
  <div id="c_name"></div>
  <div id="c_post"></div>
  <div id="c_dist"></div>
  <div id="c_code"></div>
 </div>
</div>

<!-- BACK CARD -->
<div id="back" class="card">
 <div id="qr"></div>
 <div class="backtext">
  हेल्पलाइन: 9166377972<br>
  Email: jbrrms1@gmail.com<br>
  Website: www.jbrrms.in
 </div>
</div>

<div class="actions">
<button onclick="download(front,'FRONT')">⬇️ Front</button>
<button onclick="download(back,'BACK')">⬇️ Back</button>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
 "https://ejdzdptqxelilkseannw.supabase.co",
 "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P"
);

/* NEXT MEMBER CODE */
async function nextCode(){
 const {data,error} = await sb
  .from("JBRRMS")
  .select("member_code")
  .order("member_code",{ascending:false})
  .limit(1);

 if(error || !data.length) return "JBRRMS0001";

 return "JBRRMS" + String(
  parseInt(data[0].member_code.slice(6)) + 1
 ).padStart(4,"0");
}

/* JOIN */
async function join(){

 if(
  !name.value.trim() ||
  !father.value.trim() ||
  !district.value.trim() ||
  !state.value.trim() ||
  mobile.value.trim().length !== 10 ||
  !post.value.trim() ||
  !photoInput.files.length
 ){
  alert("पूरा फॉर्म भरें");
  return;
 }

 const code = await nextCode();

 /* UPLOAD PHOTO */
 const fd = new FormData();
 fd.append("file", photoInput.files[0]);
 fd.append("upload_preset","jbrms_unsigned");

 const up = await fetch(
  "https://api.cloudinary.com/v1_1/dlqr73p7j/image/upload",
  {method:"POST",body:fd}
 );

 const img = await up.json();
 if(!img.secure_url){
  alert("Photo upload failed");
  return;
 }

 /* SAVE DATA */
 const {error} = await sb.from("JBRRMS").insert([{
  member_code: code,
  name: name.value,
  father_name: father.value,
  district: district.value,
  state: state.value,
  mobile: mobile.value,
  post: post.value,
  photo_url: img.secure_url,
 }]);

 if(error){
  alert("Data save error");
  return;
 }

 show(code);
}

/* LOAD OLD */
function loadOld(){
 if(!oldCode.value.trim()) return;
 show(oldCode.value.trim());
}

/* SHOW CARD */
async function show(code){
 const {data,error} = await sb
  .from("JBRRMS")
  .select("*")
  .eq("member_code",code)
  .single();

 if(error || !data){
  alert("Member code नहीं मिला");
  return;
 }

 joinBox.style.display="none";
 front.style.display = "block";
 back.style.display  = "block";

 c_name.innerText = data.name;
 c_post.innerText = data.post;
 c_dist.innerText = data.district + ", " + data.state;
 c_code.innerText = data.member_code;
 photo.src = data.photo_url;

 qr.innerHTML="";
 new QRCode(qr,{
  text: data.member_code,
  width:300,
  height:300
 });
}

/* DOWNLOAD */
function download(el,name){
 html2canvas(el,{scale:2,useCORS:true}).then(c=>{
  const a=document.createElement("a");
  a.download=`JBRRMS_${name}.png`;
  a.href=c.toDataURL("image/png");
  a.click();
 });
}
</script>
</body>
</html>
