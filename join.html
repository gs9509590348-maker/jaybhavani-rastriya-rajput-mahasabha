<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JBRRMS Member Registration</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;padding:15px;background:#f5f5f5}
.card{background:#fff;padding:15px;border-radius:10px;max-width:450px;margin:auto;box-shadow:0 0 10px #ccc}
input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #aaa}
button{padding:10px 14px;background:#007bff;border:0;color:white;border-radius:6px;width:100%}
</style>

</head>

<body>

<div class="card">
<h2>JBRRMS Member Registration</h2>

<label>नाम</label>
<input id="name">

<label>पिता का नाम</label>
<input id="father_name">

<label>जिला</label>
<input id="district">

<label>राज्य</label>
<input id="state">

<label>मोबाइल नंबर</label>
<input id="mobile">

<label>Photo Upload</label>
<input type="file" id="photo">

<button onclick="saveMember()">Save Member</button>

<p id="msg"></p>
</div>

<script>

// ===============================
// केवल Publishable Key ही डालना
// ===============================

const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function saveMember(){

 document.getElementById("msg").innerText = "Saving...";

 let name = document.getElementById("name").value;
 let father = document.getElementById("father_name").value;
 let district = document.getElementById("district").value;
 let state = document.getElementById("state").value;
 let mobile = document.getElementById("mobile").value;
 let file = document.getElementById("photo").files[0];

 if(!file){ alert("Photo चुनें"); return; }

 // ========== फोटो upload ==========
 let filename = Date.now() + "_" + file.name;

 let { error: uploadError } = await supabaseClient
 .storage.from("members_photos")
 .upload(filename, file);

 if(uploadError){ 
   document.getElementById("msg").innerText = "Photo upload error";
   return;
 }

 let photo_url = supabaseUrl + "/storage/v1/object/public/members_photos/" + filename;

 // ========== Auto Member Code ==========
 let { data: last } = await supabaseClient
 .from("members")
 .select("id")
 .order("id", { ascending:false })
 .limit(1);

 let next = 1;
 if(last && last.length>0) next = last[0].id + 1;

 let member_code = "JBRRMS" + String(next).padStart(4,'0');

 // ========== Save to Database ==========
 let { error } = await supabaseClient
 .from("members")
 .insert({
   member_code,
   name,
   father_name: father,
   district,
   state,
   mobile,
   post: "",       // Post अभी खाली रहेगा
   photo_url
 });

 if(error){
  document.getElementById("msg").innerText = "Data Save Error";
 }else{
  document.getElementById("msg").innerText = "Member Saved ✔\nCode: " + member_code;
 }

}

</script>
</body>
</html>
