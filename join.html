<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JBRRMS Member Registration</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;padding:15px;background:#f5f5f5}
.card{background:#fff;padding:15px;border-radius:10px;max-width:500px;margin:auto}
input,select{width:100%;padding:10px;margin:8px 0}
button{padding:10px 15px;background:#0077ff;color:#fff;border:0;border-radius:5px}
#msg{margin-top:10px;font-weight:bold}
</style>
</head>

<body>

<div class="card">
  <h2>JB RRMS — Member Registration</h2>

  <input id="name" placeholder="नाम" />
  <input id="father_name" placeholder="पिता का नाम" />
  <input id="district" placeholder="जिला" />
  <input id="state" placeholder="राज्य" />
  <input id="mobile" placeholder="मोबाइल नंबर" />
  <input id="photo" type="file" accept="image/*" />

  <button onclick="saveMember()">Save Member</button>

  <div id="msg"></div>
</div>

<script>
const supabaseUrl = "https://ejdzdptqxelilkseannw.supabase.co";
const supabaseKey = "sb_publishable_iU5rrjm63ImncflRhIkQYQ_QHyDR92P";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function saveMember(){

 document.getElementById("msg").innerText = "Saving...";

 let name = document.getElementById("name").value;
 let father = document.getElementById("father_name").value;
 let district = document.getElementById("district").value;
 let state = document.getElementById("state").value;
 let mobile = document.getElementById("mobile").value;
 let file = document.getElementById("photo").files[0];

 if(!name || !mobile){
   alert("नाम और मोबाइल जरूरी है");
   return;
 }

 if(!file){
   alert("Photo चुनें");
   return;
 }

 // ---------- PHOTO UPLOAD ----------
 let filename = "photos/" + Date.now() + "_" + file.name;

 let { error: uploadError } = await supabaseClient
 .storage.from("members")
 .upload(filename, file);

 if(uploadError){ 
   document.getElementById("msg").innerText = "Photo upload error";
   return;
 }

 let photo_url = supabaseUrl + "/storage/v1/object/public/members/" + filename;

 // ---------- COUNT for NEXT MEMBER CODE ----------
 let { count } = await supabaseClient
 .from("members")
 .select("*", { count: "exact", head: true });

 let next = (count || 0) + 1;

 let member_code = "JBRRMS" + String(next).padStart(4,'0');

 // ---------- SAVE DATA ----------
 let { error } = await supabaseClient
 .from("members")
 .insert({
   member_code,
   name,
   father_name: father,
   district,
   state,
   mobile,
   post: "",
   photo_url
 });

 if(error){
  document.getElementById("msg").innerText = "Data Save Error ❌";
 }else{
  document.getElementById("msg").innerText = "Member Saved ✔\nMember Code: " + member_code;
 }

}
</script>

</body>
</html>
