<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Edit Member | Admin â€“ JBRRMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{background:#7b0000;color:#fff;padding:14px;text-align:center}
header h2{margin:0}
header div{font-size:13px}
nav{background:#3b0000;display:flex;flex-wrap:wrap;justify-content:center}
nav a{color:#fff;text-decoration:none;padding:8px 12px;font-size:14px}
nav a:hover{background:#7b0000}

.box{
  max-width:520px;margin:25px auto;
  background:#fff;padding:20px;
  border:2px solid #7b0000;border-radius:10px
}
h3{text-align:center;color:#7b0000;margin-top:0}

input{
  width:100%;padding:9px;margin:6px 0;
  font-size:14px
}
button{
  width:100%;padding:10px;margin-top:8px;
  background:#7b0000;color:#fff;
  border:none;border-radius:6px;
  font-size:15px;cursor:pointer
}

.gray{background:#555}
.green{background:#28a745}
.red{background:#dc3545}

.ok{color:#28a745;font-weight:bold}
.no{color:#dc3545;font-weight:bold}

.badge{
  display:inline-block;padding:4px 10px;
  border-radius:20px;font-size:12px;color:#fff
}
.approved{background:#28a745}
.rejected{background:#dc3545}
.pending{background:#ff9800}

.photo{text-align:center;margin:10px 0}
.photo img{
  width:90px;height:90px;border-radius:50%;
  object-fit:cover;border:2px solid #7b0000
}

.links a{
  display:block;margin:6px 0;
  padding:8px;border-radius:6px;
  text-align:center;text-decoration:none;
  background:#eee;color:#333;font-size:13px
}
.links a.green{background:#28a745;color:#fff}
</style>
</head>

<body>

<script>
/* ğŸ” SESSION CHECK */
if(sessionStorage.getItem("admin")!=="1"){
  alert("âŒ Unauthorized Access");
  location.href="admin_login.html";
}
</script>

<header>
  <h2>âœï¸ Edit Member â€“ Admin Panel</h2>
  <div>Jay Bhavani Rashtriya Rajput Mahasabha</div>
</header>

<nav>
  <a href="admin_dashboard.html">ğŸ  Dashboard</a>
  <a href="admin_pending.html">â³ Pending</a>
  <a href="admin_bulk_approve.html">ğŸš€ Bulk Approve</a>
  <a href="admin_edit_member.html">âœï¸ Edit Member</a>
</nav>

<div class="box">
<h3>ğŸ” Search Member</h3>

<input id="mid" placeholder="Search by Member ID">
<input id="mobileSearch" placeholder="Live search by Mobile">

<div id="msg"></div>
<hr>

<div class="photo" id="photoBox" style="display:none">
  <img id="photoPreview">
</div>

<input id="name" placeholder="Name">
<input id="father" placeholder="Father">
<input id="post" placeholder="Post">
<input id="level" placeholder="Level">

<div>
  <b>Status:</b>
  <span id="statusBadge" class="badge pending">Pending</span>
</div>

<button class="green" onclick="approveMember()">âœ… Approve (Auto WhatsApp)</button>
<button class="red" onclick="setStatus('rejected')">âŒ Reject</button>
<button class="gray" onclick="setStatus('pending')">â³ Pending</button>

<div class="links" id="autoLinks" style="display:none">
  <a id="certLink" target="_blank">ğŸ“œ View Certificate</a>
  <a id="apptLink" target="_blank">ğŸ§¾ View Appointment</a>
  <a id="verifyLink" class="green" target="_blank">ğŸ” Verify Online</a>
</div>

<button onclick="downloadJSON()">â¬‡ï¸ Download Updated members.json</button>
</div>

<script>
let members=[],index=-1;
const msg=document.getElementById("msg");

/* LOAD JSON */
fetch("../data/members.json?v="+Date.now())
.then(r=>r.json())
.then(d=>members=d.filter(m=>m.member_id));

mid.onchange=()=>loadById(mid.value);
mobileSearch.oninput=()=>{
  const v=mobileSearch.value.replace(/\D/g,"");
  if(v.length<5) return;
  const i=members.findIndex(m=>String(m.mobile||"").replace(/\D/g,"").includes(v));
  if(i>=0) loadMember(i);
};

function loadById(id){
  const i=members.findIndex(m=>m.member_id.toUpperCase()===id.toUpperCase());
  if(i>=0) loadMember(i);
  else msg.innerHTML="<p class='no'>âŒ Member Not Found</p>";
}

function loadMember(i){
  index=i;
  const m=members[i];
  name.value=m.name||"";
  father.value=m.father||"";
  post.value=m.post||"";
  level.value=m.level||"";
  updateStatus(m.status||"pending");

  if(m.photo){
    photoPreview.src=m.photo;
    photoBox.style.display="block";
  }else photoBox.style.display="none";

  msg.innerHTML="<p class='ok'>âœ… Member Loaded</p>";
}

function updateStatus(s){
  statusBadge.innerText=s.charAt(0).toUpperCase()+s.slice(1);
  statusBadge.className="badge "+s;
}

function setStatus(s){
  if(index<0) return alert("Member load à¤•à¤°à¥‡à¤‚");
  members[index].status=s;
  updateStatus(s);
}

/* âœ… APPROVE + AUTO WHATSAPP */
function approveMember(){
  if(index<0) return alert("Member load à¤•à¤°à¥‡à¤‚");

  setStatus("approved");

  const m=members[index];
  const base=location.origin;

  const verify=base+"/verify.html?id="+m.member_id;
  const cert=base+"/certificate.html?id="+m.member_id;
  const appt=base+"/appointment.html?id="+m.member_id;

  certLink.href=cert;
  apptLink.href=appt;
  verifyLink.href=verify;
  autoLinks.style.display="block";

  const msgTxt =
`à¤œà¤¯ à¤­à¤µà¤¾à¤¨à¥€ | à¤œà¤¯ à¤°à¤¾à¤œà¤ªà¥‚à¤¤à¤¾à¤¨à¤¾ ğŸš©

à¤†à¤ªà¤•à¥€ à¤¸à¤¦à¤¸à¥à¤¯à¤¤à¤¾ APPROVED à¤¹à¥‹ à¤—à¤ˆ à¤¹à¥ˆ âœ…

à¤¨à¤¾à¤®: ${m.name}
Member ID: ${m.member_id}

Verify:
${verify}

Certificate:
${cert}

Appointment:
${appt}`;

  window.open(
    "https://wa.me/91"+String(m.mobile).replace(/\D/g,"")+
    "?text="+encodeURIComponent(msgTxt),
    "_blank"
  );
}

/* DOWNLOAD JSON */
function downloadJSON(){
  if(index<0) return alert("Member load à¤•à¤°à¥‡à¤‚");
  members[index].name=name.value.trim();
  members[index].father=father.value.trim();
  members[index].post=post.value.trim();
  members[index].level=level.value.trim();

  const blob=new Blob([JSON.stringify(members,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="members.json";
  a.click();
}
</script>

</body>
</html>
