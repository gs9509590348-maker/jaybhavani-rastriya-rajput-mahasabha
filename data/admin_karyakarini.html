<script>
/* ‚úÖ SAME FOLDER JSON */
const JSON_PATH = "karyakarini.json";
let data=[];

fetch(JSON_PATH)
.then(r=>r.json())
.then(j=>{
  data = (j.karyakarini || []).filter(x=>x.active!==false);
  normalizeOrder();
  render();
})
.catch(()=>alert("karyakarini.json load ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ ‡§∞‡§π‡§æ"));

function normalizeOrder(){
  data.sort((a,b)=>a.order-b.order);
  data.forEach((m,i)=>m.order=i+1);
}
function nextId(){
  return "KAR-" + String(Date.now()).slice(-6);
}

/* üîÅ level ‚Üí category mapping (PUBLIC SAFE) */
function mapCategory(level, post){
  if(post.includes("‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§™‡§ï")) return "founder";
  if(post.includes("‡§Ø‡•Å‡§µ‡§æ")) return "youth";
  if(level==="‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø") return "national";
  if(level==="‡§™‡•ç‡§∞‡§¶‡•á‡§∂") return "state";
  return "state";
}

function addMember(){
  if(!n_name.value || !n_post.value){
    alert("Name ‡§î‡§∞ Post ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à");
    return;
  }
  data.push({
    id:nextId(),
    name:n_name.value.trim(),
    post:n_post.value.trim(),
    level:n_level.value,
    category: mapCategory(n_level.value, n_post.value),
    district:n_district.value.trim(),
    state:n_state.value.trim(),
    mobile:n_mobile.value.trim(),
    photo:n_photo.value.trim(),
    order:data.length+1,
    active:true
  });
  clearNew();
  render();
}

function clearNew(){
  n_name.value=n_post.value=n_district.value=
  n_state.value=n_mobile.value=n_photo.value="";
}

function render(){
  const tb=document.getElementById("tbody");
  tb.innerHTML="";

  data.forEach((m,i)=>{
    tb.innerHTML+=`
    <tr>
      <td>${m.order}</td>
      <td><img src="${m.photo||'https://via.placeholder.com/50'}"></td>
      <td><input value="${m.name}" onchange="upd(${i},'name',this.value)"></td>
      <td><input value="${m.post}" onchange="upd(${i},'post',this.value)"></td>
      <td>
        <select onchange="upd(${i},'level',this.value)">
          <option ${m.level=='‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø'?'selected':''}>‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø</option>
          <option ${m.level=='‡§™‡•ç‡§∞‡§¶‡•á‡§∂'?'selected':''}>‡§™‡•ç‡§∞‡§¶‡•á‡§∂</option>
          <option ${m.level=='‡§ú‡§ø‡§≤‡§æ'?'selected':''}>‡§ú‡§ø‡§≤‡§æ</option>
        </select>
      </td>
      <td><input value="${m.district||''}" onchange="upd(${i},'district',this.value)"></td>
      <td><input value="${m.state||''}" onchange="upd(${i},'state',this.value)"></td>
      <td><input value="${m.mobile||''}" onchange="upd(${i},'mobile',this.value)"></td>
      <td>
        <button class="up" onclick="moveUp(${i})">‚¨Ü</button>
        <button class="down" onclick="moveDown(${i})">‚¨á</button>
        <button class="delete" onclick="del(${i})">‚ùå</button>
      </td>
    </tr>`;
  });

  document.getElementById("jsonOut").value =
JSON.stringify({
  last_updated:new Date().toISOString().split("T")[0],
  organization:"‡§ú‡§Ø ‡§≠‡§µ‡§æ‡§®‡•Ä ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø ‡§∞‡§æ‡§ú‡§™‡•Ç‡§§ ‡§Æ‡§π‡§æ‡§∏‡§≠‡§æ",
  karyakarini:data
},null,2);
}

function upd(i,k,v){
  data[i][k]=v;
  if(k==="level" || k==="post"){
    data[i].category = mapCategory(data[i].level, data[i].post);
  }
  render();
}

function del(i){
  if(confirm("Delete this member?")){
    data[i].active=false;
    data.splice(i,1);
    normalizeOrder();
    render();
  }
}

function moveUp(i){
  if(i===0) return;
  [data[i],data[i-1]]=[data[i-1],data[i]];
  normalizeOrder();render();
}
function moveDown(i){
  if(i===data.length-1) return;
  [data[i],data[i+1]]=[data[i+1],data[i]];
  normalizeOrder();render();
}
</script>
